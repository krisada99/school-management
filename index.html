<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบริหารจัดการสถานศึกษา</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: 'Sarabun', sans-serif;
        /* ✨ FIX: ทำให้หน้าหลักสามารถเลื่อนได้ตามปกติ ไม่ถูกบังคับ */
    }

    :root {
        --primary-color: #0056b3;
        --secondary-color: #28a745;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --info-color: #17a2b8;
        --light-gray: #f8f9fa;
        --dark-text: #343a40;
    }

    body {
        background-color: var(--light-gray);
        color: var(--dark-text);
    }

    #splash-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: linear-gradient(135deg, var(--primary-color), #6f42c1);
        z-index: 10000; display: flex; flex-direction: column;
        justify-content: center; align-items: center; color: white;
        transition: opacity 0.8s ease-out, visibility 0.8s;
    }
    #splash-screen.fade-out { opacity: 0; visibility: hidden; }
    .splash-icon { font-size: 5rem; animation: bounce 2s infinite; }
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-30px); }
        60% { transform: translateY(-15px); }
    }
    .splash-text { font-size: 2rem; font-weight: 600; margin-top: 20px; letter-spacing: 1px; }

    #login-container {
        min-height: 100vh; display: flex; align-items: center; justify-content: center;
        background: linear-gradient(135deg, var(--primary-color), #4086d0);
    }
    .login-card {
        width: 100%; max-width: 450px; background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        border-radius: 20px; padding: 2.5rem; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    #app-container {
        display: flex;
        height: 100vh; /* ทำให้ container สูงเต็มหน้าจอ */
        overflow: hidden; /* ป้องกันไม่ให้ทั้ง app container เลื่อน */
    }

    #sidebar {
        width: 280px; min-width: 280px; background-color: #2c3e50;
        color: white; transition: all 0.3s ease-in-out; z-index: 1040;
        display: flex; flex-direction: column; /* จัดเรียงแนวตั้ง */
        height: 100%; /* สูงเต็ม #app-container */
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    #sidebar .sidebar-header {
        padding: 1.8rem 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        text-align: center; flex-shrink: 0; /* ✨ FIX: ไม่ให้ส่วนหัวหดตัว */
    }
    #sidebar .sidebar-header .text-muted { color: #a0a0a0 !important; }
    #sidebar .sidebar-header h3 { font-weight: 700; margin-bottom: 0.5rem; }
    #sidebar .sidebar-header p { margin: 0; font-size: 0.9em; }

    /* --- ✨ FIX: ส่วนแก้ไขหลักเพื่อให้เมนูเลื่อนได้ --- */
    .sidebar-menu-wrapper {
        flex-grow: 1; /* ทำให้ wrapper ขยายเต็มพื้นที่ที่เหลือ */
        display: flex;
        flex-direction: column;
        overflow-y: auto; /* ✨ ทำให้ wrapper นี้สามารถเลื่อนแนวตั้งได้ */
        min-height: 0; /* แก้ปัญหา flexbox ในบาง browser */
    }
    #sidebar #main-menu {
        padding-top: 1rem;
        padding-bottom: 1rem;
        /* ไม่ต้องมี flex-grow หรือ overflow ที่นี่แล้ว */
    }
.sidebar-footer {
    flex-shrink: 0; /* ไม่ให้ส่วนท้ายหดตัว */
    padding: 0.5rem 1rem 1.5rem 1rem; /* เพิ่ม Padding ซ้าย-ขวา 1rem */
}
    /* --- จบส่วนแก้ไข --- */
    
    #sidebar .nav-link {
        color: rgba(255, 255, 255, 0.85); padding: 14px 28px; font-size: 1.05rem;
        display: flex; align-items: center; transition: all 0.3s;
        border-left: 4px solid transparent;
    }
    #sidebar .nav-link .fa-fw { margin-right: 18px; font-size: 1.1em; }
    #sidebar .nav-link:hover, #sidebar .nav-link.active {
        background-color: var(--primary-color); color: white; border-left-color: var(--secondary-color);
    }
    #sidebar .nav-link .fas.fa-chevron-down { transition: transform 0.3s ease-in-out; }
    #sidebar .nav-link[data-bs-toggle="collapse"][aria-expanded="true"] .fas.fa-chevron-down { transform: rotate(180deg); }
    #sidebar .btn-toggle-nav .nav-item .nav-link { padding-left: 45px; font-size: 0.98rem; }
    #sidebar .btn-toggle-nav .btn-toggle-nav .nav-item .nav-link { padding-left: 65px; font-size: 0.95rem; }
    #sidebar .nav-link.disabled { opacity: 0.6; cursor: not-allowed; }
    #main-menu .collapse { background-color: #2c3e50; }
    #main-menu .btn-toggle-nav .nav-link:hover,
    #main-menu .btn-toggle-nav .nav-link.active {
        background-color: var(--primary-color); color: white; border-left-color: var(--secondary-color);
    }

    .version-text {
        color: #b0b0b0; text-align: center; font-size: 0.85rem; padding: 0.5rem 1rem;
    }
#logout-btn {
    margin-top: 0.5rem; /* กำหนดแค่ระยะห่างด้านบน */
    background-color: var(--danger-color);
    border-color: var(--danger-color);
}
    #logout-btn:hover { background-color: #bd2130; border-color: #bd2130; }

    #main-content {
        flex-grow: 1; overflow-y: auto; position: relative;
        background-color: var(--light-gray); display: flex; flex-direction: column;
    }
    .top-navbar {
        display: flex; align-items: center; padding: 1rem 2rem;
        background-color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        position: sticky; top: 0; z-index: 1020;
    }
    #sidebar-toggle-btn {
        display: none; font-size: 1.8rem; color: var(--dark-text);
        background: none; border: none; cursor: pointer; padding: 0 1.5rem 0 0;
    }
    .content-wrapper { padding: 2.5rem; flex-grow: 1; }
    
    .sidebar-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); z-index: 1030;
        opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
    }
    .sidebar-overlay.active { opacity: 1; visibility: visible; }

    @media (max-width: 992px) {
        #sidebar { position: fixed; left: -280px; }
        #sidebar.active { left: 0; }
        #sidebar-toggle-btn { display: block; }
    }

    .content-view { display: none; }
    .content-view.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .card { border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
    .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); transition: background-color 0.2s, border-color 0.2s; }
    .btn-primary:hover { background-color: #004494; border-color: #004494; }
    .btn-success { background-color: var(--secondary-color); border-color: var(--secondary-color); }
    .btn-success:hover { background-color: #218838; border-color: #218838; }
    .table { vertical-align: middle; }
    .table thead { background-color: #e9ecef; }

    .modal-header { background: var(--primary-color); color: white; border-top-left-radius: 12px; border-top-right-radius: 12px; }
    .modal-header .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
    .dashboard-card { border-left: 5px solid var(--primary-color); transition: transform 0.2s, box-shadow 0.2s; }
    .dashboard-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .dashboard-card .card-icon { font-size: 2.5rem; color: var(--primary-color); opacity: 0.7; }

    .dropzone {
        border: 2px dashed var(--primary-color); border-radius: 10px; padding: 2rem;
        text-align: center; background: rgba(255, 255, 255, 0.8);
        transition: all 0.3s; cursor: pointer;
    }
    .dropzone.dragover { background: rgba(0, 86, 179, 0.1); border-color: var(--secondary-color); }
    .dropzone i { font-size: 2.5rem; color: var(--primary-color); }
    .dropzone p { margin: 0.5rem 0; }
    .file-info { margin-top: 1rem; font-size: 0.9rem; color: var(--dark-text); }
    .logo-preview {
        max-width: 150px; max-height: 150px; margin-top: 1rem; border: 1px solid #ddd;
        padding: 5px; border-radius: 5px; background-color: #fff;
    }

    /* Styles for Settings Tabs */
    .nav-tabs .nav-link {
        color: var(--dark-text);
    }
    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
        font-weight: 600;
    }

    /* --- START: Timetable View Styles --- */
.timetable-view-table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
}
.timetable-view-table th, .timetable-view-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
    vertical-align: middle;
    font-size: 0.9rem;
    height: 120px; /* กำหนดความสูงของช่องตาราง */
}
.timetable-view-table th {
    background-color: #f2f2f2;
    font-weight: 600;
}
.timetable-view-table .day-header {
    width: 120px; /* กำหนดความกว้างของหัวตาราง (คาบ) */
}
.timetable-entry {
    padding: 8px;
    border-radius: 6px;
    color: #fff;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    font-size: 0.85rem;
    line-height: 1.3;
}
.timetable-entry .subject {
    font-weight: bold;
    font-size: 0.9rem;
}
.timetable-entry .teacher {
    font-style: italic;
    opacity: 0.9;
    font-size: 0.8rem;
}
.timetable-class-title {
    background-color: var(--primary-color);
    color: white;
    padding: 10px;
    border-radius: 8px 8px 0 0;
    margin-top: 2rem;
}
/* ======================================================== */
/* === วางโค้ดที่แก้ไขแล้วนี้แทนที่ @media print เดิม === */
/* ======================================================== */
@media print {
    /* ซ่อนทุกอย่างในหน้าเว็บเป็นค่าเริ่มต้น */
    body * {
        visibility: hidden;
    }

    /* ----------------------------------------------------------------- */
    /* ทำให้ Modal และเนื้อหาทั้งหมดข้างใน "มองเห็นได้" สำหรับการพิมพ์ */
    /* ----------------------------------------------------------------- */
    #timetable-view-modal, #timetable-view-modal * {
        visibility: visible;
    }

    /* จัดการให้ Modal แสดงผลเต็มหน้ากระดาษ */
    #timetable-view-modal {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: visible !important; /* สำคัญ: ป้องกันเนื้อหาถูกตัด */
    }

    #timetable-view-modal .modal-dialog,
    #timetable-view-modal .modal-content {
        width: 100% !important;
        max-width: 100% !important;
        box-shadow: none !important;
        border: none !important;
        margin: 0;
    }

    /* ซ่อนส่วนหัวและท้ายของ Modal ที่ไม่ต้องการพิมพ์ */
    #timetable-view-modal .modal-header,
    #timetable-view-modal .modal-footer {
        display: none !important;
    }

    /* ป้องกันตารางถูกตัดแบ่งครึ่งระหว่างหน้า */
    .timetable-view-table {
        page-break-inside: avoid;
    }

    /* ------------------------------------------------------------- */
    /* บังคับให้เบราว์เซอร์พิมพ์ "สีพื้นหลัง" ของตาราง (สำคัญมาก) */
    /* ------------------------------------------------------------- */
    .timetable-entry {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
        print-color-adjust: exact !important;
    }
}
</style>
</head>
<body>

    <div id="splash-screen">
        <i class="fas fa-graduation-cap splash-icon"></i>
        <h1 class="splash-text">ระบบบริหารจัดการสถานศึกษา</h1>
        <p>กำลังโหลดข้อมูล... กรุณารอสักครู่</p>
    </div>

    <div id="login-container">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-school fa-3x" style="color: var(--primary-color);"></i>
                <h3 class="mt-3">ระบบบริหารจัดการสถานศึกษา</h3>
                <p class="text-muted">สำหรับผู้ดูแลระบบ, ผู้บริหาร และบุคลากร</p>
            </div>
            <form id="login-form" class="needs-validation" novalidate>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="username" placeholder="Username" required>
                    <label for="username">ชื่อผู้ใช้งาน</label>
                    <div class="invalid-feedback">กรุณากรอกชื่อผู้ใช้งาน</div>
                </div>
                
                <div class="form-floating mb-4 position-relative">
                    <input type="password" class="form-control" id="password" placeholder="Password" required>
                    <label for="password">รหัสผ่าน</label>
                    <span id="toggle-password" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #6c757d;">
                        <i class="fas fa-eye"></i>
                    </span>
                    <div class="invalid-feedback">กรุณากรอกรหัสผ่าน</div>
                </div>
                <button type="submit" class="btn btn-primary w-100 btn-lg">
                    <i class="fas fa-sign-in-alt me-2"></i>เข้าสู่ระบบ
                </button>
                
                <div class="text-center mt-3">
                    <a href="#" id="forgot-password-link" class="text-decoration-none">ลืมรหัสผ่าน?</a>
                </div>
            </form>
        </div>
    </div>

    <div id="app-container" class="d-none">
        <nav id="sidebar">
            <div class="sidebar-header">
                <h5 style="font-weight: 300; margin-bottom: 0.5rem;">ยินดีต้อนรับ</h5>
                <h4 id="user-name-sidebar" style="margin-bottom: 0.25rem;">คุณ ชื่อผู้ใช้งาน</h4>
                <p id="user-role-sidebar" class="text-muted" style="margin: 0;"></p>
            </div>
            <div class="sidebar-menu-wrapper">
                <ul id="main-menu" class="nav flex-column">
                    </ul>
                <div class="flex-grow-1"></div> <ul id="settings-menu" class="nav flex-column mt-auto">
                     </ul>
                <div class="sidebar-footer">
                    <div class="version-text">School Management v1.0</div>
                    <button id="logout-btn" class="btn btn-danger w-100">
                        <i class="fas fa-sign-out-alt fa-fw"></i> <span>ออกจากระบบ</span>
                    </button>
                </div>
            </div>
        </nav>

        <div class="sidebar-overlay"></div>

        <main id="main-content">
            <div class="top-navbar">
                <button id="sidebar-toggle-btn"><i class="fas fa-bars"></i></button>
                <h4 class="m-0 page-title" style="color: var(--dark-text);">ระบบบริหารจัดการสถานศึกษา</h4>
            </div>

            <div class="content-wrapper">
                <div id="dashboard-view" class="content-view">
                    <h2><i class="fas fa-tachometer-alt me-2"></i>แผงควบคุม</h2><hr>
                    <div class="row g-4" id="dashboard-stats">
                        <div class="col-md-4">
                            <div class="card dashboard-card" style="border-left-color: var(--primary-color);">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5>จำนวนนักเรียน</h5>
                                        <h2 class="fw-bold" id="total-students">0</h2>
                                    </div>
                                    <i class="fas fa-user-graduate card-icon" style="color: var(--primary-color);"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card dashboard-card" style="border-left-color: var(--secondary-color);">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5>จำนวนครู/บุคลากร</h5>
                                        <h2 class="fw-bold" id="total-teachers">0</h2>
                                    </div>
                                    <i class="fas fa-chalkboard-teacher card-icon" style="color: var(--secondary-color);"></i>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card dashboard-card" style="border-left-color: var(--info-color);">
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5>จำนวนผู้บริหาร</h5>
                                        <h2 class="fw-bold" id="total-admins">0</h2>
                                    </div>
                                    <i class="fas fa-user-shield card-icon" style="color: var(--info-color);"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="school-info-view" class="content-view">
                    <h2><i class="fas fa-school me-2"></i>จัดการข้อมูลโรงเรียน</h2><hr>
                    <div class="card"><div class="card-body">
                        <form id="school-info-form" class="needs-validation" novalidate>
                            <input type="hidden" id="schoolId">
                            <div class="mb-3">
                                <label for="schoolName" class="form-label">ชื่อโรงเรียน</label>
                                <input type="text" class="form-control" id="schoolName" required>
                                <div class="invalid-feedback">กรุณากรอกชื่อโรงเรียน</div>
                            </div>
                            <div class="mb-3">
                                <label for="address" class="form-label">ที่อยู่</label>
                                <textarea class="form-control" id="address" rows="3" required></textarea>
                                <div class="invalid-feedback">กรุณากรอกที่อยู่</div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label">เบอร์โทรศัพท์</label>
                                    <input type="tel" class="form-control" id="phone">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">อีเมล</label>
                                    <input type="email" class="form-control" id="email">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="principalName" class="form-label">ชื่อผู้อำนวยการ</label>
                                <input type="text" class="form-control" id="principalName">
                            </div>
                            <div class="mb-3">
                                <label for="logoFile" class="form-label">โลโก้โรงเรียน (PNG, JPG, PDF)</label>
                                <div class="dropzone" id="logoDropzone">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <p>ลากและวางไฟล์ที่นี่ หรือคลิกเพื่อเลือกไฟล์</p>
                                    <p class="text-muted">รองรับ JPG, PNG, PDF (สูงสุด 5MB)</p>
                                    <input type="file" id="logoFile" accept=".pdf,.png,.jpg,.jpeg" style="display: none;">
                                </div>
                                <div class="file-info d-flex align-items-center" id="logoFileInfo">
                                    <span id="logoFileName"></span>
                                    <button type="button" class="btn btn-sm btn-danger ms-2" id="removeLogoFileBtn" style="display: none;"><i class="fas fa-trash"></i></button>
                                </div>
                                <img id="logoPreview" class="logo-preview" src="#" alt="School Logo Preview" style="display:none;">
                            </div>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>บันทึกข้อมูลโรงเรียน</button>
                        </form>
                    </div></div>
                </div>

                <div id="admin-view" class="content-view">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2><i class="fas fa-users me-2"></i>จัดการผู้ใช้งาน</h2>
                        <button class="btn btn-success" id="addUserBtn"><i class="fas fa-user-plus me-2"></i>เพิ่มผู้ใช้งาน</button>
                    </div><hr>
                    <div class="card"><div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr>
                                    <th>ชื่อ-สกุล</th><th>เลขประจำตัว</th><th>ตำแหน่ง</th><th>ชื่อผู้ใช้</th><th>บทบาท</th><th>จัดการ</th>
                                </tr></thead>
                                <tbody id="admin-table-body"></tbody>
                            </table>
                        </div>
                    </div></div>
                </div>

                <div id="class-level-view" class="content-view">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2><i class="fas fa-layer-group me-2"></i>จัดการระดับชั้น</h2>
                        <button class="btn btn-success" id="addClassLevelBtn"><i class="fas fa-plus-circle me-2"></i>เพิ่มระดับชั้น</button>
                    </div><hr>
                    <div class="card"><div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr>
                                    <th>ชื่อระดับชั้น</th>
                                    <th>คำอธิบาย</th>
                                    <th>จัดการ</th>
                                </tr></thead>
                                <tbody id="class-level-table-body"></tbody>
                            </table>
                        </div>
                    </div></div>
                </div>

                <div id="subject-view" class="content-view">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2><i class="fas fa-book-open me-2"></i>จัดการรายวิชา</h2>
                        <button class="btn btn-success" id="addSubjectBtn"><i class="fas fa-plus-circle me-2"></i>เพิ่มรายวิชา</button>
                    </div><hr>
                    <div class="card"><div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr>
                                    <th>รหัสวิชา</th>
                                    <th>ชื่อรายวิชา</th>
                                    <th>ประเภทวิชา</th> <th>หน่วยกิต</th>
                                    <th>จัดการ</th>
                                </tr></thead>
                                <tbody id="subject-table-body"></tbody>
                            </table>
                        </div>
                    </div></div>
                </div>

                <div id="student-view" class="content-view">
<div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
    <h2 class="m-0"><i class="fas fa-user-graduate me-2"></i>จัดการนักเรียน</h2>
    
    <div class="d-flex flex-wrap gap-2" aria-label="Student Actions">
        <button class="btn btn-info" id="downloadStudentTemplateBtn"><i class="fas fa-download me-2"></i>ดาวน์โหลดเทมเพลต</button>
        <button class="btn btn-primary" id="importStudentBtn"><i class="fas fa-upload me-2"></i>นำเข้าข้อมูล</button>
        <input type="file" id="studentCsvFile" accept=".csv" style="display: none;">
        <button class="btn btn-success" id="addStudentBtn"><i class="fas fa-user-plus me-2"></i>เพิ่มนักเรียน</button>
    </div>
</div>
<hr>

<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title mb-3">กรองข้อมูลนักเรียน</h5>
        <div class="row g-3">
            <div class="col-md-5">
                <label for="filterStudentGrade" class="form-label">ระดับชั้น</label>
                <select id="filterStudentGrade" class="form-select"></select>
            </div>
            <div class="col-md-5">
                <label for="filterStudentClass" class="form-label">ห้องเรียน</label>
                <select id="filterStudentClass" class="form-select"></select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary w-100" id="searchStudentBtn"><i class="fas fa-search me-2"></i>ค้นหา</button>
            </div>
        </div>
    </div>
</div>

                    <div class="card"><div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr>
                                    <th>รหัสนักเรียน</th><th>ชื่อ-สกุล</th><th>เพศ</th><th>ระดับชั้น</th><th>ห้อง</th><th>ชื่อผู้ปกครอง</th><th>เบอร์ผู้ปกครอง</th><th>จัดการ</th>
                                </tr></thead>
                                <tbody id="student-table-body"></tbody>
                            </table>
                        </div>
                    </div></div>
                </div>

                <div id="online-grade-view" class="content-view">
                    <h2><i class="fas fa-poll-h me-2"></i>ระบบดูผลการเรียนออนไลน์</h2><hr>
                    <p>เนื้อหาสำหรับระบบดูผลการเรียนออนไลน์จะปรากฏที่นี่</p>
                </div>
                <div id="supervision-view" class="content-view">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2><i class="fas fa-chalkboard-teacher me-2"></i>ระบบนิเทศภายในสถานศึกษา</h2>
                        <button class="btn btn-success" id="addSupervisionBtn"><i class="fas fa-plus-circle me-2"></i>เพิ่มบันทึกการนิเทศ</button>
                    </div><hr>
                    <div class="card"><div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr>
                                    <th>วันที่นิเทศ</th>
                                    <th>ผู้นิเทศ</th>
                                    <th>ผู้ถูกนิเทศ</th>
                                    <th>ประเด็นที่นิเทศ</th>
                                    <th>สถานะ</th>
                                    <th>จัดการ</th>
                                </tr></thead>
                                <tbody id="supervision-table-body"></tbody>
                            </table>
                        </div>
                    </div></div>
                </div>

                <div id="timetable-management-view" class="content-view">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2><i class="fas fa-calendar-alt me-2"></i>ระบบจัดตารางสอน</h2>
                        <div> 
                            <button class="btn btn-info" id="viewTimetableBtn">
                                <i class="fas fa-table-list me-2"></i>สร้างตารางสอน (รูปแบบตาราง)
                            </button>
                            <button class="btn btn-success" id="addTimetableBtn">
                                <i class="fas fa-plus-circle me-2"></i>เพิ่มตารางสอน
                            </button>
                        </div>
                    </div><hr>
                    <div class="card"><div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="filterAcademicYear" class="form-label">ปีการศึกษา</label>
                                <input type="text" class="form-control" id="filterAcademicYear" placeholder="เช่น 2567">
                            </div>
                            <div class="col-md-4">
                                <label for="filterSemester" class="form-label">ภาคเรียน</label>
                                <input type="text" class="form-control" id="filterSemester" placeholder="เช่น 1">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-primary w-100" id="applyTimetableFilter">
                                    <i class="fas fa-filter me-2"></i>กรองข้อมูล
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead><tr>
                                    <th>ปี/ภาคเรียน</th>
                                    <th>ระดับชั้น</th>
                                    <th>รายวิชา</th>
                                    <th>ครูผู้สอน</th>
                                    <th>นักเรียน</th>
                                    <th>วัน</th>
                                    <th>เวลา</th>
                                    <th>ห้อง</th>
                                    <th>จัดการ</th>
                                </tr></thead>
                                <tbody id="timetable-table-body"></tbody>
                            </table>
                        </div>
                    </div></div>
                </div>
                <div id="budget-management-system-view" class="content-view">
                    <h2><i class="fas fa-coins me-2"></i>ระบบบริหารเงินงบประมาณ</h2><hr>
                    <p>เนื้อหาสำหรับระบบบริหารเงินงบประมาณจะปรากฏที่นี่</p>
                </div>
                <div id="personnel-management-system-view" class="content-view">
                    <h2><i class="fas fa-users-line me-2"></i>ระบบบริหารอัตรากำลังในสถานศึกษา</h2><hr>
                    <p>เนื้อหาสำหรับระบบบริหารอัตรากำลังในสถานศึกษาจะปรากฏที่นี่</p>
                </div>
                <div id="building-management-system-view" class="content-view">
                    <h2><i class="fas fa-city me-2"></i>ระบบบริหารงานอาคารสถานที่</h2><hr>
                    <p>เนื้อหาสำหรับระบบบริหารงานอาคารสถานที่จะปรากฏที่นี่</p>
                </div>
                
   <div id="digital-document-view" class="content-view">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
        <h2 class="m-0"><i class="fas fa-file-alt me-2"></i>จัดการเอกสารดิจิทัล</h2>
        <button class="btn btn-success" id="addDigitalDocumentBtn"><i class="fas fa-plus-circle me-2"></i>เพิ่มเอกสารใหม่</button>
    </div>
   
<hr>
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title mb-3">ค้นหาเอกสาร</h5>
        
        <form id="digital-document-filter-form">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="filterDocAcademicYear" class="form-label">ปีการศึกษา</label>
                    <select id="filterDocAcademicYear" class="form-select"></select>
                </div>
                <div class="col-md-2">
                    <label for="filterDocSemester" class="form-label">ภาคเรียน</label>
                    <select id="filterDocSemester" class="form-select"></select>
                </div>
                <div class="col-md-3">
                    <label for="filterDocDepartment" class="form-label">ฝ่ายงาน</label>
                    <select id="filterDocDepartment" class="form-select">
                        <option value="">ทั้งหมด</option>
                        <option value="academic-management">บริหารงานวิชาการ</option>
                        <option value="budget-management">บริหารงานงบประมาณ</option>
                        <option value="personnel-management">บริหารงานบุคคล</option>
                        <option value="general-management">บริหารงานทั่วไป</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filterDocNumber" class="form-label">เลขที่/ชื่อเอกสาร</label>
                    <input type="text" id="filterDocNumber" class="form-control" placeholder="ค้นหา...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100" id="searchDigitalDocumentBtn">
                        <i class="fas fa-search me-2"></i>ค้นหา
                    </button>
                </div>
            </div>
        </form>
        </div>
</div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ลำดับ</th>
                            <th>เลขที่เอกสาร</th>
                            <th>เรื่อง</th>
                            <th>ฝ่ายงาน</th>
                            <th>ปี/ภาคเรียน</th>
                            <th>ผู้อัปโหลด</th>
                            <th>วันที่อัปโหลด</th>
                            <th>จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="digital-documents-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="digitalDocumentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="digital-document-form" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title" id="digitalDocumentModalTitle">เพิ่มเอกสารดิจิทัลใหม่</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="docTitle" class="form-label">เรื่อง/ชื่อเอกสาร</label>
                        <input type="text" class="form-control" id="docTitle" name="docTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="docDescription" class="form-label">คำอธิบายเพิ่มเติม (ถ้ามี)</label>
                        <textarea class="form-control" id="docDescription" name="docDescription" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="docAcademicYear" class="form-label">ปีการศึกษา</label>
                            <select class="form-select" id="docAcademicYear" name="academicYear" required></select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="docSemester" class="form-label">ภาคเรียน</label>
                            <select class="form-select" id="docSemester" name="semester" required>
                                <option value="">-- เลือกภาคเรียน --</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="ฤดูร้อน">ฤดูร้อน</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="docDepartment" class="form-label">ฝ่ายงานที่เกี่ยวข้อง</label>
                        <select class="form-select" id="docDepartment" name="department" required>
                            <option value="">-- เลือกฝ่ายงาน --</option>
                            <option value="academic-management">บริหารงานวิชาการ</option>
                            <option value="budget-management">บริหารงานงบประมาณ</option>
                            <option value="personnel-management">บริหารงานบุคคล</option>
                            <option value="general-management">บริหารงานทั่วไป</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="docFiles" class="form-label">ไฟล์เอกสาร (สูงสุด 5 ไฟล์, ไฟล์ละไม่เกิน 50MB)</label>
                        <input class="form-control" type="file" id="docFiles" name="docFiles[]" multiple required accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png">
                        <div id="doc-file-preview" class="mt-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="submit" class="btn btn-primary" id="saveDigitalDocumentBtn"><i class="fas fa-upload me-2"></i>อัปโหลดและบันทึก</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="documentDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">รายละเอียดเอกสาร</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="documentDetailsBody">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>

                <div id="settings-view" class="content-view">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2><i class="fas fa-cogs me-2"></i>ตั้งค่าระบบ</h2>
                    </div>
                    <hr>
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="settings-tabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="academic-term-tab" data-bs-toggle="tab" data-bs-target="#academic-term-panel" type="button" role="tab">
                                        <i class="fas fa-calendar-alt me-1"></i> ปีการศึกษา/ภาคเรียน
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="fiscal-year-tab" data-bs-toggle="tab" data-bs-target="#fiscal-year-panel" type="button" role="tab">
                                        <i class="fas fa-coins me-1"></i> ปีงบประมาณ
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="holiday-tab" data-bs-toggle="tab" data-bs-target="#holiday-panel" type="button" role="tab">
                                        <i class="fas fa-mug-hot me-1"></i> วันหยุด
                                    </button>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content" id="settings-tab-content">
                                <div class="tab-pane fade show active" id="academic-term-panel" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4>รายการปีการศึกษา/ภาคเรียน</h4>
                                        <button class="btn btn-success" id="addAcademicTermBtn"><i class="fas fa-plus-circle me-2"></i>เพิ่มปีการศึกษา</button>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ปีการศึกษา</th>
                                                    <th>ภาคเรียน</th>
                                                    <th>วันเริ่มต้น</th>
                                                    <th>วันสิ้นสุด</th>
                                                    <th>สถานะปัจจุบัน</th>
                                                    <th>จัดการ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="academic-terms-table-body"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="fiscal-year-panel" role="tabpanel">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4>รายการปีงบประมาณ</h4>
                                        <button class="btn btn-success" id="addFiscalYearBtn"><i class="fas fa-plus-circle me-2"></i>เพิ่มปีงบประมาณ</button>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ปีงบประมาณ</th>
                                                    <th>วันเริ่มต้น</th>
                                                    <th>วันสิ้นสุด</th>
                                                    <th>สถานะปัจจุบัน</th>
                                                    <th>จัดการ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="fiscal-years-table-body"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="holiday-panel" role="tabpanel">
                                     <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4>รายการวันหยุด</h4>
                                        <button class="btn btn-success" id="addHolidayBtn"><i class="fas fa-plus-circle me-2"></i>เพิ่มวันหยุด</button>
                                    </div>
                                   
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>คำอธิบาย</th>
                                                    <th>วันเริ่มต้น</th>
                                                    <th>วันสิ้นสุด</th>
                                                    <th>ปีงบประมาณ</th>
                                                    <th>จัดการ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="holidays-table-body"></tbody>
                                        </table>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal fade" id="academicTermModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="academic-term-form" class="needs-validation" novalidate>
                    <input type="hidden" id="editTermId">
                    <div class="modal-header">
                        <h5 class="modal-title" id="academicTermModalTitle"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="academicYear" class="form-label">ปีการศึกษา</label>
                            <input type="text" class="form-control" id="academicYear" placeholder="เช่น 2567" required>
                        </div>
                        <div class="mb-3">
                            <label for="semester" class="form-label">ภาคเรียน</label>
                            <input type="text" class="form-control" id="semester" placeholder="เช่น 1" required>
                        </div>
                        <div class="mb-3">
                            <label for="termStartDate" class="form-label">วันที่เริ่มต้น</label>
                            <input type="date" class="form-control" id="termStartDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="termEndDate" class="form-label">วันที่สิ้นสุด</label>
                            <input type="date" class="form-control" id="termEndDate" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary" id="saveAcademicTermBtn"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="fiscalYearModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="fiscal-year-form" class="needs-validation" novalidate>
                    <input type="hidden" id="editFiscalYearId">
                    <div class="modal-header">
                        <h5 class="modal-title" id="fiscalYearModalTitle"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="fiscalYear" class="form-label">ปีงบประมาณ</label>
                            <input type="text" class="form-control" id="fiscalYear" placeholder="เช่น 2568" required>
                        </div>
                        <div class="mb-3">
                            <label for="fiscalStartDate" class="form-label">วันที่เริ่มต้น</label>
                            <input type="date" class="form-control" id="fiscalStartDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="fiscalEndDate" class="form-label">วันที่สิ้นสุด</label>
                            <input type="date" class="form-control" id="fiscalEndDate" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary" id="saveFiscalYearBtn"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="holidayModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="holiday-form" class="needs-validation" novalidate>
                    <input type="hidden" id="editHolidayId">
                    <div class="modal-header">
                        <h5 class="modal-title" id="holidayModalTitle"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="holidayDescription" class="form-label">คำอธิบาย</label>
                            <input type="text" class="form-control" id="holidayDescription" placeholder="เช่น วันหยุดเทศกาลสงกรานต์" required>
                        </div>
                        <div class="mb-3">
                            <label for="holidayFiscalYear" class="form-label">ปีงบประมาณ</label>
                            <select class="form-select" id="holidayFiscalYear" required>
                                <option value="">-- เลือกปีงบประมาณ --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="holidayStartDate" class="form-label">วันที่เริ่มต้น</label>
                            <input type="date" class="form-control" id="holidayStartDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="holidayEndDate" class="form-label">วันที่สิ้นสุด</label>
                            <input type="date" class="form-control" id="holidayEndDate" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary" id="saveHolidayBtn"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="user-form" class="needs-validation" novalidate>
                    <input type="hidden" id="editUserId">
                    <div class="modal-header"><h5 class="modal-title" id="userModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-4 mb-3"><label for="userPrefix" class="form-label">คำนำหน้า</label><input type="text" class="form-control" id="userPrefix" required></div>
                            <div class="col-md-4 mb-3"><label for="userName" class="form-label">ชื่อ</label><input type="text" class="form-control" id="userName" required></div>
                            <div class="col-md-4 mb-3"><label for="userSurname" class="form-label">นามสกุล</label><input type="text" class="form-control" id="userSurname" required></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label for="userEmployeeId" class="form-label">เลขประจำตัวบุคลากร (ถ้ามี)</label><input type="text" class="form-control" id="userEmployeeId"></div>
                            <div class="col-md-6 mb-3"><label for="userPosition" class="form-label">ตำแหน่ง</label><input type="text" class="form-control" id="userPosition" required></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label for="userPhone" class="form-label">เบอร์โทรศัพท์</label><input type="tel" class="form-control" id="userPhone"></div>
                            <div class="col-md-6 mb-3"><label for="userEmail" class="form-label">อีเมล</label><input type="email" class="form-control" id="userEmail"></div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label for="userUsername" class="form-label">ชื่อผู้ใช้งาน</label><input type="text" class="form-control" id="userUsername" required></div>
                            <div class="col-md-6 mb-3"><label for="userPassword" class="form-label">รหัสผ่าน</label><input type="text" class="form-control" id="userPassword" required></div>
                        </div>
                        <div class="mb-3" id="userRoleSection">
                            <label for="userRole" class="form-label">บทบาท</label>
                            <select class="form-select" id="userRole" required>
                                <option value="teacher">ครู/บุคลากร (Teacher)</option>
                                <option value="principal">ผู้บริหาร (Principal)</option>
                                <option value="admin">ผู้ดูแลระบบ (Admin)</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3 ps-4 pe-4" id="teacherPermissionsSection" style="display: none;">
                        <label class="form-label">สิทธิ์การเข้าถึง (สำหรับครู)</label>
                        <div class="p-3 border rounded">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="academic-management" id="perm-academic">
                                <label class="form-check-label" for="perm-academic">
                                    บริหารงานวิชาการ
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="budget-management" id="perm-budget">
                                <label class="form-check-label" for="perm-budget">
                                    บริหารงานงบประมาณ
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="personnel-management" id="perm-personnel">
                                <label class="form-check-label" for="perm-personnel">
                                    บริหารงานบุคคล
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" value="general-management" id="perm-general">
                                <label class="form-check-label" for="perm-general">
                                    บริหารงานทั่วไป
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary" id="saveUserBtn"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="studentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="student-form" class="needs-validation" novalidate>
                    <input type="hidden" id="editStudentId">
                    <div class="modal-header"><h5 class="modal-title" id="studentModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="studentCode" class="form-label">รหัสนักเรียน</label>
                            <input type="text" class="form-control" id="studentCode" required>
                            <div class="invalid-feedback">กรุณากรอกรหัสนักเรียน</div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3"><label for="studentPrefix" class="form-label">คำนำหน้า</label><input type="text" class="form-control" id="studentPrefix" required></div>
                            <div class="col-md-4 mb-3"><label for="studentName" class="form-label">ชื่อ</label><input type="text" class="form-control" id="studentName" required></div>
                            <div class="col-md-4 mb-3"><label for="studentSurname" class="form-label">นามสกุล</label><input type="text" class="form-control" id="studentSurname" required></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label for="studentDateOfBirth" class="form-label">วันเกิด</label><input type="date" class="form-control" id="studentDateOfBirth"></div>
                            <div class="col-md-6 mb-3"><label for="studentGender" class="form-label">เพศ</label><select class="form-select" id="studentGender">
                                <option value="">-- เลือกเพศ --</option><option value="ชาย">ชาย</option><option value="หญิง">หญิง</option>
                            </select></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="studentGrade" class="form-label">ระดับชั้น</label>
                                <select class="form-select" id="studentGrade">
                                    <option value="">-- เลือกระดับชั้น --</option>
                                    </select>
                            </div>
                            <div class="col-md-6 mb-3"><label for="studentClass" class="form-label">ห้อง</label><input type="text" class="form-control" id="studentClass"></div>
                        </div>
                        <hr>
                        <h5>ข้อมูลผู้ปกครอง (ถ้ามี)</h5>
                        <div class="mb-3"><label for="parentName" class="form-label">ชื่อ-สกุล ผู้ปกครอง</label><input type="text" class="form-control" id="parentName"></div>
                        <div class="mb-3"><label for="parentPhone" class="form-label">เบอร์โทรศัพท์ ผู้ปกครอง</label><input type="tel" class="form-control" id="parentPhone"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary" id="saveStudentBtn"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="classLevelModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="class-level-form" class="needs-validation" novalidate>
                    <input type="hidden" id="editClassLevelId">
                    <div class="modal-header"><h5 class="modal-title" id="classLevelModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="className" class="form-label">ชื่อระดับชั้น</label>
                            <input type="text" class="form-control" id="className" required>
                            <div class="invalid-feedback">กรุณากรอกชื่อระดับชั้น</div>
                        </div>
                        <div class="mb-3">
                            <label for="classDescription" class="form-label">คำอธิบาย (ถ้ามี)</label>
                            <textarea class="form-control" id="classDescription" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary" id="saveClassLevelBtn"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="subjectModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="subject-form" class="needs-validation" novalidate>
                    <input type="hidden" id="editSubjectId">
                    <div class="modal-header"><h5 class="modal-title" id="subjectModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                  
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="subjectCode" class="form-label">รหัสวิชา</label>
                            <input type="text" class="form-control" id="subjectCode" required>
                            <div class="invalid-feedback">กรุณากรอกรหัสวิชา</div>
                        </div>
                        <div class="mb-3">
                            <label for="subjectName" class="form-label">ชื่อวิชา</label>
                            <input type="text" class="form-control" id="subjectName" required>
                            <div class="invalid-feedback">กรุณากรอกชื่อวิชา</div>
                        </div>
                        <div class="mb-3">
                            <label for="subjectType" class="form-label">ประเภทวิชา</label>
                            <select class="form-select" id="subjectType" required>
                                <option value="">-- เลือกประเภทวิชา --</option>
                                <option value="วิชาพื้นฐาน">วิชาพื้นฐาน</option>
                                <option value="วิชาเพิ่มเติม">วิชาเพิ่มเติม</option>
                                <option value="วิชาเลือกเสรี">วิชาเลือกเสรี</option>
                                <option value="กิจกรรมพัฒนาผู้เรียน">กิจกรรมพัฒนาผู้เรียน</option>
                            </select>
                            <div class="invalid-feedback">กรุณาเลือกประเภทวิชา</div>
                        </div>
                        <div class="mb-3">
                            <label for="subjectCredits" class="form-label">หน่วยกิต</label>
                            <input type="number" step="0.5" class="form-control" id="subjectCredits">
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary" id="saveSubjectBtn"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="supervisionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="supervision-form" class="needs-validation" novalidate>
                    <input type="hidden" id="editSupervisionRecordId">
                    <div class="modal-header"><h5 class="modal-title" id="supervisionModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="supervisionDate" class="form-label">วันที่นิเทศ</label>
                            <input type="date" class="form-control" id="supervisionDate" required>
                            <div class="invalid-feedback">กรุณาระบุวันที่นิเทศ</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="supervisorId" class="form-label">ผู้นิเทศ</label>
                                <select class="form-select" id="supervisorId" required>
                                    <option value="">-- เลือกผู้นิเทศ --</option>
                                </select>
                                <div class="invalid-feedback">กรุณาเลือกผู้นิเทศ</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="superviseeId" class="form-label">ผู้ถูกนิเทศ</label>
                                <select class="form-select" id="superviseeId" required>
                                    <option value="">-- เลือกผู้ถูกนิเทศ --</option>
                                </select>
                                <div class="invalid-feedback">กรุณาเลือกผู้ถูกนิเทศ</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="focusArea" class="form-label">ประเด็นที่นิเทศ</label>
                            <textarea class="form-control" id="focusArea" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="observations" class="form-label">ข้อสังเกต</label>
                            <textarea class="form-control" id="observations" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="feedback" class="form-label">ข้อเสนอแนะ</label>
                            <textarea class="form-control" id="feedback" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="followUp" class="form-label">การติดตามผล</label>
                            <textarea class="form-control" id="followUp" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="supervisionStatus" class="form-label">สถานะ</label>
                            <select class="form-select" id="supervisionStatus" required>
                                <option value="Completed">Completed</option>
                                <option value="Planned">Planned</option>
                                <option value="Canceled">Canceled</option>
                            </select>
                        </div>

                        <hr>
                        <h5>ไฟล์แนบ</h5>

                        <div class="mb-3">
                            <label for="supervisionResultFile" class="form-label">ผลการนิเทศ (PDF, DOC, DOCX - ไม่เกิน 10MB)</label>
                            <div class="dropzone" id="resultFileDropzone" style="height: auto; padding: 1rem;">
                                <i class="fas fa-file-upload"></i>
                                <p>ลากและวางไฟล์ที่นี่ หรือคลิกเพื่อเลือกไฟล์</p>
                                <p class="text-muted">รองรับ PDF, DOC, DOCX (สูงสุด 10MB)</p>
                                <input type="file" id="supervisionResultFile" accept=".pdf,.doc,.docx" style="display: none;">
                            </div>
                            <div class="file-info d-flex align-items-center mt-2" id="resultFileInfo">
                                <span id="resultFileName"></span>
                                <button type="button" class="btn btn-sm btn-danger ms-2" id="removeResultFileBtn" style="display: none;"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="supervisionPhotoFiles" class="form-label">รูปประกอบการนิเทศ (JPG, PNG - ไม่เกิน 5 รูป, รูปละ 5MB)</label>
                            <div class="dropzone" id="photoFilesDropzone" style="height: auto; padding: 1rem;">
                                <i class="fas fa-camera"></i>
                                <p>ลากและวางรูปภาพที่นี่ หรือคลิกเพื่อเลือกรูปภาพ</p>
                                <p class="text-muted">รองรับ JPG, PNG (สูงสุด 5 รูป, รูปละ 5MB)</p>
                                <input type="file" id="supervisionPhotoFiles" accept="image/jpeg,image/png" multiple style="display: none;">
                            </div>
                            <div id="photoPreviews" class="mt-2 d-flex flex-wrap gap-2">
                                </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary" id="saveSupervisionBtn"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="timetableModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="timetable-form" class="needs-validation" novalidate>
                    <input type="hidden" id="editTimetableEntryId">
                    <div class="modal-header"><h5 class="modal-title" id="timetableModalTitle"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="timetableAcademicYear" class="form-label">ปีการศึกษา</label>
                                <input type="text" class="form-control" id="timetableAcademicYear" required readonly>
                                <div class="invalid-feedback">กรุณากรอกปีการศึกษา</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="timetableSemester" class="form-label">ภาคเรียน</label>
                                <input type="text" class="form-control" id="timetableSemester" required readonly>
                                <div class="invalid-feedback">กรุณากรอกภาคเรียน</div>
                            </div>
                            </div>
                        <div class="mb-3">
                            <label for="timetableClassLevel" class="form-label">ระดับชั้น</label>
                            <select class="form-select" id="timetableClassLevel" required>
                                <option value="">-- เลือกระดับชั้น --</option>
                            </select>
                            <div class="invalid-feedback">กรุณาเลือกระดับชั้น</div>
                        </div>
                        <div class="mb-3">
                            <label for="timetableSubject" class="form-label">รายวิชา</label>
                            <select class="form-select" id="timetableSubject" required>
                                <option value="">-- เลือกรายวิชา --</option>
                            </select>
                            <div class="invalid-feedback">กรุณาเลือกรายวิชา</div>
                        </div>
                        <div class="mb-3">
                            <label for="timetableTeacher" class="form-label">ครูผู้สอน</label>
                            <select class="form-select" id="timetableTeacher" required>
                                <option value="">-- เลือกครูผู้สอน --</option>
                            </select>
                            <div class="invalid-feedback">กรุณาเลือกครูผู้สอน</div>
                        </div>
                        
                        <div id="timetableStudentContainer" class="mb-3" style="display: none;">
                            <label for="timetableStudent" class="form-label">นักเรียน (สำหรับวิชาเลือกเสรี)</label>
                            <select class="form-select" id="timetableStudent" multiple size="8">
                            </select>
                            <small class="form-text text-muted">กด Ctrl (หรือ Cmd บน Mac) ค้างไว้เพื่อเลือกหลายคน</small>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="timetableDayOfWeek" class="form-label">วันในสัปดาห์</label>
                                <select class="form-select" id="timetableDayOfWeek" required>
                                    <option value="">-- เลือกวัน --</option>
                                    <option value="Monday">จันทร์</option>
                                    <option value="Tuesday">อังคาร</option>
                                    <option value="Wednesday">พุธ</option>
                                    <option value="Thursday">พฤหัสบดี</option>
                                    <option value="Friday">ศุกร์</option>
                                    <option value="Saturday">เสาร์</option>
                                    <option value="Sunday">อาทิตย์</option>
                                </select>
                                <div class="invalid-feedback">กรุณาเลือกวัน</div>
                            </div>
                             <div class="col-md-6 mb-3">
                                <label for="timetableRoom" class="form-label">ห้องเรียน</label>
                                <select class="form-select" id="timetableRoom">
                                    <option value="">-- เลือกห้องเรียน (ถ้ามี) --</option>
                                </select>
                            </div>
                             </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="timetableStartTime" class="form-label">เวลาเริ่มต้น</label>
                                <input type="time" class="form-control" id="timetableStartTime" required>
                                <div class="invalid-feedback">กรุณาระบุเวลาเริ่มต้น</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="timetableEndTime" class="form-label">เวลาสิ้นสุด</label>
                                <input type="time" class="form-control" id="timetableEndTime" required>
                                <div class="invalid-feedback">กรุณาระบุเวลาสิ้นสุด</div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                        <button type="submit" class="btn btn-primary" id="saveTimetableBtn"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="timetable-view-modal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ตารางสอนรูปแบบตาราง</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body printable-area" id="timetable-view-body">
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                    <button type="button" class="btn btn-primary" id="printTimetableBtn">
                        <i class="fas fa-print me-2"></i>พิมพ์ตารางสอน
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // --- GLOBAL STATE ---
    let currentUser = null;
    let schoolInfo = {};
    let allUsers = []; 
    let allStudents = [];
    let allClassLevels = [];
    let allSubjects = [];
    let allSupervisionRecords = [];
    let allTimetableEntries = [];
    let allDigitalDocuments = [];
    let timetableDropdownData = { teachers: [], classLevels: [], subjects: [], students: [] };
    let selectedLogoFile = null;

    // --- START: ✨ โค้ดที่เพิ่มสำหรับ Pagination ---
    const rowsPerPage = 10;
    let currentPage = {
        admin: 1,
        classLevel: 1,
        subject: 1,
        student: 1,
        supervision: 1,
        timetable: 1,
        academicTerms: 1,
        fiscalYears: 1,
        holidays: 1,
        digitalDocuments: 1
    };
    // --- END: ✨ โค้ดที่เพิ่มสำหรับ Pagination ---

    // --- NEW: Global state for all settings data ---
    let allSettings = {
        academicTerms: [],
        fiscalYears: [],
        holidays: []
    };

    // NEW: Global state for supervision files
    let currentSupervisionResultFile = null;
    let currentSupervisionPhotoFiles = [];

// --- API HELPER FUNCTION ---
async function apiCall(endpoint, payload, isFormData = false) {
    try {
        const fetchOptions = {
            method: 'POST',
        };

        if (isFormData) {
            // ไม่ต้องตั้งค่า Content-Type header, browser จะจัดการให้เอง
            fetchOptions.body = payload;
        } else {
            fetchOptions.headers = { 'Content-Type': 'application/json' };
            fetchOptions.body = JSON.stringify(payload);
        }

        const response = await fetch(`api/${endpoint}`, fetchOptions);

        const responseText = await response.text();
        let data;

        try {
            data = JSON.parse(responseText);
        } catch (jsonError) {
            console.error(`--- JSON PARSE FAILED on endpoint: ${endpoint} ---`);
            console.error("Original Error:", jsonError);
            console.log("RAW response text from server was:", responseText);
            throw new Error('Server returned an invalid response. Check console for details.');
        }

        if (!response.ok) {
            throw new Error(data.error || `HTTP error! status: ${response.status}`);
        }

        return data;

    } catch (error) {
        console.error(`API Call Error (${endpoint}):`, error);
        return { success: false, error: error.message };
    }
}

    // --- UTILITY FUNCTIONS ---
    const showLoadingAlert = (title = 'กำลังประมวลผล...') => { Swal.fire({ title: title, allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } }); };
    const showSuccessAlert = (title, text) => Swal.fire({ icon: 'success', title, text });
    const showErrorAlert = (title, text) => Swal.fire({ icon: 'error', title, text });
    const formatDate = (dateString) => {
        if (!dateString || dateString === '0000-00-00') return '-';
        try {
            return new Date(dateString).toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric' });
        } catch (e) {
            return dateString;
        }
    };

    // --- START: ✨ เพิ่มฟังก์ชันแปลงขนาดไฟล์ ---
function formatBytes(bytes, decimals = 2) {
    if (!bytes || bytes === 0) return '0 Bytes';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}
// --- END: ✨ เพิ่มฟังก์ชันแปลงขนาดไฟล์ ---

    function handleMenuClick(e) {
        e.preventDefault();
        const link = e.target.closest('.nav-link');
        if (!link) return;

        const targetViewId = link.dataset.view;
        if (targetViewId) {
            showView(targetViewId);
        }
    }

    function showView(viewId) {
        document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active'));
        const view = document.getElementById(viewId);
        if (view) view.classList.add('active');

        document.querySelectorAll('#main-menu .nav-link, #settings-menu .nav-link').forEach(l => l.classList.remove('active'));
        
        const activeLink = document.querySelector(`.nav-link[data-view="${viewId}"]`);
        if (activeLink) {
            activeLink.classList.add('active');
            let currentParent = activeLink.closest('.collapse');
            while (currentParent) {
                const collapseInstance = bootstrap.Collapse.getOrCreateInstance(currentParent);
                collapseInstance.show();
                const parentLink = document.querySelector(`a[href="#${currentParent.id}"]`);
                parentLink?.classList.add('active');
                currentParent = currentParent.parentElement.closest('.collapse');
            }
        }
        
        document.getElementById('sidebar').classList.remove('active');
        document.querySelector('.sidebar-overlay').classList.remove('active');
    }

    // --- LOGIN / LOGOUT ---
    async function handleLogin(e) {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) return;
        showLoadingAlert('กำลังเข้าสู่ระบบ...');
        const payload = { username: document.getElementById('username').value, password: document.getElementById('password').value };
        const result = await apiCall('login.php', payload);
        Swal.close();
        if (result && result.success) {
            currentUser = result;
            document.getElementById('login-container').classList.add('d-none');
            document.getElementById('app-container').classList.remove('d-none');
            initializeAppUI(result);
        } else {
            showErrorAlert('ผิดพลาด', result.error || 'ชื่อผู้ใช้งานหรือรหัสผ่านไม่ถูกต้อง');
        }
    }

    function handleLogout() {
        Swal.fire({
            title: 'ต้องการออกจากระบบ?', icon: 'question', showCancelButton: true,
            confirmButtonText: 'ใช่, ออกจากระบบ', cancelButtonText: 'ยกเลิก'
        }).then((result) => { if (result.isConfirmed) { currentUser = null; window.location.reload(); } });
    }

// --- START: ✨ ฟังก์ชันใหม่สำหรับสร้าง Pagination (แก้ไขแล้ว) ---
    function renderPagination(containerId, tableKey, totalItems, parentElement) {
        // ตรวจสอบว่ามี parentElement ที่จะใส่ pagination controls หรือไม่
        if (!parentElement) return;

        // ค้นหาหรือสร้าง container สำหรับ pagination
        let container = document.getElementById(containerId);
        if (!container) {
            container = document.createElement('div');
            container.id = containerId;
            parentElement.appendChild(container); // นำ container ไปต่อท้าย parentElement
        }

        const page = currentPage[tableKey];
        const totalPages = Math.ceil(totalItems / rowsPerPage);

        if (totalPages <= 1) {
            container.innerHTML = ''; // ถ้ามีหน้าเดียว ไม่ต้องแสดงอะไร
            return;
        }

        let paginationHtml = `<nav aria-label="Page navigation"><ul class="pagination pagination-sm justify-content-end mb-0">`;

        // Previous Button
        paginationHtml += `<li class="page-item ${page === 1 ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${page - 1}" data-key="${tableKey}">ก่อนหน้า</a></li>`;

        // Page Numbers
        for (let i = 1; i <= totalPages; i++) {
            paginationHtml += `<li class="page-item ${i === page ? 'active' : ''}"><a class="page-link" href="#" data-page="${i}" data-key="${tableKey}">${i}</a></li>`;
        }

        // Next Button
        paginationHtml += `<li class="page-item ${page === totalPages ? 'disabled' : ''}"><a class="page-link" href="#" data-page="${page + 1}" data-key="${tableKey}">ถัดไป</a></li>`;
        paginationHtml += `</ul></nav>`;

        // แสดงผลลัพธ์
        container.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted small">หน้าที่ ${page} จาก ${totalPages} (ทั้งหมด ${totalItems} รายการ)</div>
                ${paginationHtml}
            </div>
        `;
    }
    // --- END: ✨ ฟังก์ชันใหม่สำหรับสร้าง Pagination (แก้ไขแล้ว) ---

    // --- UI INITIALIZATION & RENDERING ---
    function initializeAppUI(user) {
        currentUser = user; 
        document.getElementById('user-name-sidebar').textContent = user.name;
        const roleMap = { 'teacher': 'ครู/บุคลากร', 'principal': 'ผู้บริหาร', 'admin': 'ผู้ดูแลระบบ' };
        document.getElementById('user-role-sidebar').textContent = roleMap[user.role] || user.role;
        buildMenu();
        loadInitialData();
        showView('dashboard-view');
    }

   // --- START: ✨ โค้ดที่แก้ไข ---
async function loadInitialData() {
    showLoadingAlert('กำลังโหลดข้อมูล...');
    const results = await Promise.all([
        apiCall('school_handler.php', { action: 'get' }),
        apiCall('admin_handler.php', { action: 'get' }),
        apiCall('class_level_handler.php', { action: 'get' }),
        apiCall('subject_handler.php', { action: 'get' }),
        apiCall('student_handler.php', { action: 'get' }),
        apiCall('supervision/supervision_handler.php', { action: 'get' }),
        apiCall('academic/timetable_handler.php', { action: 'get' }),
        apiCall('academic/timetable_handler.php', { action: 'get_dropdown_data' }),
        apiCall('settings_handler.php', { entity: 'get_all_settings', action: 'get' }),
        apiCall('digital_documents/digital_document_handler.php', { action: 'get', filters: {} })
    ]);
    Swal.close();

    const [schoolRes, usersRes, classLevelRes, subjectRes, studentRes, supervisionRes, timetableRes, dropdownRes, settingsRes, digitalDocumentsRes] = results;

    // FIX: ทำให้การโหลดข้อมูลทั้งหมดมีความทนทานต่อข้อผิดพลาด (Defensive Loading)
    // โดยจะตรวจสอบว่าข้อมูลที่ได้เป็น Array หรือ Object ที่ถูกต้องหรือไม่ ถ้าไม่จะกำหนดค่าเริ่มต้นให้เป็นค่าว่าง
    schoolInfo = (schoolRes?.success && schoolRes.schoolInfo) ? schoolRes.schoolInfo : {};
    allUsers = (usersRes?.success && Array.isArray(usersRes.users)) ? usersRes.users : [];
    allClassLevels = (classLevelRes?.success && Array.isArray(classLevelRes.classLevels)) ? classLevelRes.classLevels : [];
    allSubjects = (subjectRes?.success && Array.isArray(subjectRes.subjects)) ? subjectRes.subjects : [];
    allSupervisionRecords = (supervisionRes?.success && Array.isArray(supervisionRes.supervisionRecords)) ? supervisionRes.supervisionRecords : [];
    allTimetableEntries = (timetableRes?.success && Array.isArray(timetableRes.timetableEntries)) ? timetableRes.timetableEntries : [];
    allSettings = (settingsRes?.success) ? settingsRes : { academicTerms: [], fiscalYears: [], holidays: [] };
    allDigitalDocuments = (digitalDocumentsRes?.success && Array.isArray(digitalDocumentsRes.documents)) ? digitalDocumentsRes.documents : [];

    // บรรทัดนี้คือส่วนที่แก้ไขปัญหาโดยตรง
    allStudents = (studentRes?.success && Array.isArray(studentRes.students)) ? studentRes.students : [];
    
    // สำหรับ Dropdown Data จะตรวจสอบแยกต่างหาก
    timetableDropdownData = (dropdownRes?.success) ? dropdownRes : { teachers: [], classLevels: [], subjects: [], students: [], classRooms: [] };

    // (Optional) แสดงข้อความเตือนหาก API ตัวใดตัวหนึ่งล้มเหลว โดยไม่ทำให้โปรแกรมหยุดทำงาน
    if (!studentRes?.success) {
        console.error("Failed to load student data:", studentRes?.error);
        showErrorAlert('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดข้อมูลนักเรียนได้');
    }
    if (!usersRes?.success) {
        console.error("Failed to load user data:", usersRes?.error);
    }
    // สามารถเพิ่มการตรวจสอบสำหรับ API อื่นๆ ได้ตามต้องการ

    renderAllViews();
}
// --- END: ✨ โค้ดที่แก้ไข ---

function renderAllViews() {
    renderDashboard();
    renderSchoolInfoForm();
    renderAdminTable(); 
    renderClassLevelTable(); 
    renderSubjectTable(); 
    populateStudentFilters();
    renderStudentTable();
    renderSupervisionTable();
    renderTimetableTable();
    renderSettingsTables();
    // --- START: ✨ เพิ่มการเรียก render ใหม่ ---
    renderDigitalDocumentsTable();
    populateDigitalDocumentFilters(); // เรียกฟังก์ชัน populate filter
    // --- END: ✨ เพิ่มการเรียก render ใหม่ ---
}

        // ✨ ฟังก์ชันใหม่สำหรับ Populate ตัวกรองข้อมูลนักเรียน
    function populateStudentFilters() {
        const gradeSelect = document.getElementById('filterStudentGrade');
        const classSelect = document.getElementById('filterStudentClass');

        // Populate ระดับชั้น
        gradeSelect.innerHTML = '<option value="">-- ทุกระดับชั้น --</option>';
        allClassLevels.forEach(cl => {
            gradeSelect.innerHTML += `<option value="${cl.className}">${cl.className}</option>`;
        });

        // Populate ห้องเรียน (จากข้อมูลนักเรียนทั้งหมดที่มีอยู่)
        const uniqueClasses = [...new Set(allStudents.map(s => s.class).filter(c => c))].sort();
        classSelect.innerHTML = '<option value="">-- ทุกห้องเรียน --</option>';
        uniqueClasses.forEach(room => {
            classSelect.innerHTML += `<option value="${room}">${room}</option>`;
        });
    }

    function buildMenu() {
        const mainMenu = document.getElementById('main-menu');
        const settingsMenu = document.getElementById('settings-menu');
        mainMenu.innerHTML = '';
        settingsMenu.innerHTML = '';

        const menuStructure = [
            { id: 'dashboard-view', icon: 'fa-tachometer-alt', text: 'แผงควบคุม' },
            { id: 'school-info-view', icon: 'fa-school', text: 'ข้อมูลโรงเรียน' },
            { id: 'admin-view', icon: 'fa-users', text: 'จัดการผู้ใช้งาน' }, 
            { id: 'class-level-view', icon: 'fa-layer-group', text: 'จัดการระดับชั้น' },
            { id: 'subject-view', icon: 'fa-book-open', text: 'จัดการรายวิชา' }, 
            { id: 'student-view', icon: 'fa-user-graduate', text: 'จัดการนักเรียน' },
            { id: 'digital-document-view', icon: 'fa-file-alt', text: 'เอกสารดิจิทัล' },
            {
                id: 'four-departments-parent', icon: 'fa-sitemap', text: 'บริหารงาน 4 ฝ่าย',
                children: [
                    {
                        id: 'academic-management', parentId: 'four-departments-parent', icon: 'fa-book', text: 'บริหารงานวิชาการ',
                        children: [
                            { parentId: 'academic-management', id: 'online-grade-view', icon: 'fa-poll-h', text: 'ระบบดูผลการเรียนออนไลน์' },
                            { parentId: 'academic-management', id: 'supervision-view', icon: 'fa-chalkboard-teacher', text: 'ระบบนิเทศภายในสถานศึกษา' },
                            { parentId: 'academic-management', id: 'timetable-management-view', icon: 'fa-calendar-alt', text: 'ระบบจัดตารางสอน' }
                        ]
                    },
                    { id: 'budget-management', parentId: 'four-departments-parent', icon: 'fa-money-bill-wave', text: 'บริหารงานงบประมาณ', children: [ { parentId: 'budget-management', id: 'budget-management-system-view', icon: 'fa-coins', text: 'ระบบบริหารเงินงบประมาณ' } ] },
                    { id: 'personnel-management', parentId: 'four-departments-parent', icon: 'fa-users-cog', text: 'บริหารงานบุคคล', children: [ { parentId: 'personnel-management', id: 'personnel-management-system-view', icon: 'fa-users-line', text: 'ระบบบริหารอัตรากำลังในสถานศึกษา' } ] },
                    { id: 'general-management', parentId: 'four-departments-parent', icon: 'fa-building', text: 'บริหารงานทั่วไป', children: [ { parentId: 'general-management', id: 'building-management-system-view', icon: 'fa-city', text: 'ระบบบริหารงานอาคารสถานที่' } ] }
                ]
            }
        ];

        // --- NEW: Settings Menu Structure ---
        const settingsMenuStructure = [
            {
                id: 'settings-parent', icon: 'fa-cogs', text: 'ตั้งค่าระบบ',
                children: [
                    { parentId: 'settings-parent', id: 'settings-view', icon: 'fa-sliders-h', text: 'จัดการการตั้งค่า' }
                ]
            }
        ];

    function hasAccess(item) {
        const userRole = currentUser.role;
        const userPermissions = currentUser.permissions || [];

        // Admin และ Principal เห็นทุกอย่าง
        if (userRole === 'admin' || userRole === 'principal') return true;

        // --- START: ✨ แก้ไขเงื่อนไขการเข้าถึง ---
        // ทุกคนสามารถเห็นเมนูหลักๆ และเมนูเอกสารดิจิทัล
        const publicViews = ['dashboard-view', 'digital-document-view'];
        if (publicViews.includes(item.id)) return true;
        // --- END: ✨ แก้ไขเงื่อนไขการเข้าถึง ---

        if (userRole === 'teacher') {
            if (userPermissions.includes(item.id)) return true;
            if (item.parentId && userPermissions.includes(item.parentId)) return true;
            if (item.id === 'four-departments-parent' && item.children) {
                return item.children.some(dept => userPermissions.includes(dept.id));
            }
        }
        return false;
    }

        function createMenuItem(item) {
            if (!hasAccess(item)) return '';
            let html = `<li class="nav-item">`;
            if (item.children) {
                const childrenHtml = item.children.map(createMenuItem).join('');
                if (!childrenHtml) return '';
                html += `<a class="nav-link" href="#${item.id}-collapse" data-bs-toggle="collapse" role="button">
                            <i class="fas ${item.icon} fa-fw"></i><span>${item.text}</span><i class="fas fa-chevron-down ms-auto"></i>
                         </a>
                         <div class="collapse" id="${item.id}-collapse">
                            <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small">${childrenHtml}</ul>
                         </div>`;
            } else {
                html += `<a class="nav-link" href="#" data-view="${item.id}">
                            <i class="fas ${item.icon} fa-fw"></i><span>${item.text}</span>
                         </a>`;
            }
            html += `</li>`;
            return html;
        }

        mainMenu.innerHTML = menuStructure.map(createMenuItem).join('');
        // Add a separator before settings menu if main menu has content
        if (mainMenu.innerHTML.trim() !== '') {
            settingsMenu.innerHTML += '<hr class="mx-3" style="border-color: rgba(255,255,255,0.2);">';
        }
        settingsMenu.innerHTML += settingsMenuStructure.map(createMenuItem).join('');
    }
    
    // --- RENDER VIEWS/TABLES ---
    function renderDashboard() {
        document.getElementById('total-students').textContent = allStudents.length;
        document.getElementById('total-teachers').textContent = allUsers.filter(u => u.role === 'teacher').length;
        document.getElementById('total-admins').textContent = allUsers.filter(u => u.role === 'principal').length;
    }

    // --- START: ✨ เพิ่มฟังก์ชันใหม่ทั้งหมดสำหรับระบบเอกสาร ---

// ฟังก์ชันสำหรับ Populate ตัวกรองหน้าเอกสาร
function populateDigitalDocumentFilters() {
    const yearSelect = document.getElementById('filterDocAcademicYear');
    const semesterSelect = document.getElementById('filterDocSemester');
    if (!yearSelect || !semesterSelect) return;

    // ดึงปีการศึกษาที่ไม่ซ้ำกันจาก allSettings
    const uniqueYears = [...new Set(allSettings.academicTerms.map(term => term.academicYear))].sort((a, b) => b - a);
    
    yearSelect.innerHTML = '<option value="">ทุกปีการศึกษา</option>';
    uniqueYears.forEach(year => {
        yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
    });
    
    // ดึงภาคเรียนที่ไม่ซ้ำกันจาก allSettings
    const uniqueSemesters = [...new Set(allSettings.academicTerms.map(term => term.semester))].sort();
    
    semesterSelect.innerHTML = '<option value="">ทุกภาคเรียน</option>';
    uniqueSemesters.forEach(semester => {
        semesterSelect.innerHTML += `<option value="${semester}">${semester}</option>`;
    });
}

// ฟังก์ชันสำหรับ Render ตารางเอกสาร
function renderDigitalDocumentsTable(documentsToRender = allDigitalDocuments) {
    const tbody = document.getElementById('digital-documents-table-body');
    if (!tbody) return;

    const page = currentPage.digitalDocuments;
    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const paginatedData = documentsToRender.slice(start, end);

    tbody.innerHTML = '';
    if (paginatedData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center">ไม่พบข้อมูลเอกสาร</td></tr>`;
    } else {
        const departmentMap = {
            'academic-management': 'บริหารงานวิชาการ',
            'budget-management': 'บริหารงานงบประมาณ',
            'personnel-management': 'บริหารงานบุคคล',
            'general-management': 'บริหารงานทั่วไป'
        };

        paginatedData.forEach((doc, index) => {
            const sequenceNumber = start + index + 1;
            let actions = `
                <button class="btn btn-sm btn-info action-btn" data-action="view_doc" data-id="${doc.docId}" title="ดูรายละเอียด"><i class="fas fa-eye"></i></button>
            `;
            // อนุญาตให้ผู้ดูแลระบบ, ผู้บริหาร หรือคนที่อัปโหลดเองลบได้
            if (currentUser.role === 'admin' || currentUser.role === 'principal' || currentUser.userId === doc.uploadedBy) {
                actions += ` <button class="btn btn-sm btn-danger ms-1 action-btn" data-action="delete_doc" data-id="${doc.docId}" title="ลบ"><i class="fas fa-trash"></i></button>`;
            }
            
            tbody.innerHTML += `<tr data-id="${doc.docId}">
                <td>${sequenceNumber}</td>
                <td>${doc.docNumber}</td>
                <td>${doc.docTitle}</td>
                <td><span class="badge bg-secondary">${departmentMap[doc.department] || doc.department}</span></td>
                <td>${doc.academicYear} / ${doc.semester}</td>
                <td>${doc.uploaderName}</td>
                <td>${formatDate(doc.uploadedAt)}</td>
                <td>${actions}</td>
            </tr>`;
        });
    }
    
    const parentElement = tbody.closest('.card-body');
    renderPagination('digital-docs-pagination', 'digitalDocuments', documentsToRender.length, parentElement);
}

// ฟังก์ชันแสดง Modal สำหรับเพิ่มเอกสาร
function showAddDigitalDocumentModal() {
    showAddModal('digitalDocumentModal', 'digitalDocumentModalTitle', 'เพิ่มเอกสารดิจิทัลใหม่', 'saveDigitalDocumentBtn', 'อัปโหลดและบันทึก');
    
    const yearSelect = document.getElementById('docAcademicYear');
    const semesterSelect = document.getElementById('docSemester');
    if (!yearSelect || !semesterSelect) return;

    // ดึงปีการศึกษาที่ไม่ซ้ำกันและเรียงจากมากไปน้อย
    const uniqueYears = [...new Set(allSettings.academicTerms.map(term => term.academicYear))].sort((a, b) => b - a);
    
    yearSelect.innerHTML = '<option value="">-- เลือกปีการศึกษา --</option>';
    uniqueYears.forEach(year => {
        yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
    });

    // ดึงภาคเรียนที่ไม่ซ้ำกัน
    const uniqueSemesters = [...new Set(allSettings.academicTerms.map(term => term.semester))].sort();

    semesterSelect.innerHTML = '<option value="">-- เลือกภาคเรียน --</option>';
    uniqueSemesters.forEach(semester => {
        semesterSelect.innerHTML += `<option value="${semester}">${semester}</option>`;
    });
    
    // ตั้งค่าปี/ภาคเรียนปัจจุบัน (ถ้ามี) เป็นค่าเริ่มต้น
    const currentTerm = allSettings.academicTerms.find(term => term.isCurrent);
    if (currentTerm) {
        yearSelect.value = currentTerm.academicYear;
        semesterSelect.value = currentTerm.semester;
    }

    document.getElementById('doc-file-preview').innerHTML = '';
    document.getElementById('digital-document-form').reset();
    
    // ตั้งค่าปีและภาคเรียนอีกครั้งหลังจาก reset form
    if (currentTerm) {
        yearSelect.value = currentTerm.academicYear;
        semesterSelect.value = currentTerm.semester;
    }
}

// ฟังก์ชันจัดการการ Submit ฟอร์มเอกสาร
async function handleDigitalDocumentFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    
    const files = document.getElementById('docFiles').files;
    if (files.length === 0) {
        showErrorAlert('ข้อมูลไม่ครบถ้วน', 'กรุณาเลือกไฟล์อย่างน้อย 1 ไฟล์');
        return;
    }
    // ✨ แก้ไขจำนวนไฟล์สูงสุดเป็น 5
    if (files.length > 5) {
        showErrorAlert('ไฟล์เกินกำหนด', 'สามารถอัปโหลดได้สูงสุด 5 ไฟล์ต่อครั้ง');
        return;
    }
    for(let i = 0; i < files.length; i++) {
        // ✨ แก้ไขขนาดไฟล์สูงสุดเป็น 50MB
        if (files[i].size > 50 * 1024 * 1024) { // 50 MB
            showErrorAlert('ไฟล์มีขนาดใหญ่เกินไป', `ไฟล์ "${files[i].name}" มีขนาดใหญ่กว่า 50MB`);
            return;
        }
    }

    showLoadingAlert('กำลังอัปโหลดและบันทึก...');
    const formData = new FormData(form);
    formData.append('action', 'add');
    formData.append('userId', currentUser.userId);

    const result = await apiCall('digital_documents/digital_document_handler.php', formData, true); // true for FormData

    if (result.success) {
        bootstrap.Modal.getInstance(document.getElementById('digitalDocumentModal')).hide();
        showSuccessAlert('สำเร็จ!', result.message).then(() => loadInitialData());
    } else {
        Swal.close();
        showErrorAlert('เกิดข้อผิดพลาด', result.error);
    }
}

// ฟังก์ชันแสดง Modal รายละเอียดเอกสาร
async function showDigitalDocumentDetailsModal(docId) {
    const doc = allDigitalDocuments.find(d => d.docId === docId);
    if (!doc) return;

    showLoadingAlert('กำลังโหลดรายละเอียด...');
    const result = await apiCall('digital_documents/digital_document_handler.php', { action: 'get_document_details', docId: docId });
    Swal.close();
    
    if (!result.success) {
        showErrorAlert('ผิดพลาด', result.error);
        return;
    }
    
    const departmentMap = {
            'academic-management': 'บริหารงานวิชาการ',
            'budget-management': 'บริหารงานงบประมาณ',
            'personnel-management': 'บริหารงานบุคคล',
            'general-management': 'บริหารงานทั่วไป'
    };

    let filesHtml = '<p>ไม่พบไฟล์แนบ</p>';
    if (result.files && result.files.length > 0) {
        filesHtml = result.files.map(file => `
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-file me-2"></i> ${file.fileName}
                    <small class="text-muted ms-2">(${formatBytes(file.fileSize)})</small>
                </div>
                <a href="${file.fileUrl}" target="_blank" class="btn btn-sm btn-primary">
                    <i class="fas fa-download me-1"></i> ดาวน์โหลด
                </a>
            </li>
        `).join('');
        filesHtml = `<ul class="list-group list-group-flush">${filesHtml}</ul>`;
    }

    const modalBody = document.getElementById('documentDetailsBody');
    modalBody.innerHTML = `
        <h5>เรื่อง: ${doc.docTitle}</h5>
        <p><strong>เลขที่เอกสาร:</strong> ${doc.docNumber}</p>
        <p><strong>ฝ่ายงาน:</strong> ${departmentMap[doc.department] || doc.department}</p>
        <p><strong>ปีการศึกษา/ภาคเรียน:</strong> ${doc.academicYear} / ${doc.semester}</p>
        <p><strong>ผู้อัปโหลด:</strong> ${doc.uploaderName}</p>
        <p><strong>วันที่อัปโหลด:</strong> ${formatDate(doc.uploadedAt)}</p>
        <hr>
        <h6>คำอธิบาย</h6>
        <p>${doc.docDescription || 'ไม่มี'}</p>
        <hr>
        <h6>ไฟล์แนบ</h6>
        ${filesHtml}
    `;

    const modal = new bootstrap.Modal(document.getElementById('documentDetailsModal'));
    modal.show();
}

// ฟังก์ชันสำหรับกรองข้อมูลเอกสาร (เรียก API จาก Backend)
async function filterDigitalDocuments(e) {
    e.preventDefault(); // ป้องกันฟอร์มรีเฟรชหน้า
    
    const filters = {
        academicYear: document.getElementById('filterDocAcademicYear').value,
        semester: document.getElementById('filterDocSemester').value,
        department: document.getElementById('filterDocDepartment').value,
        docNumber: document.getElementById('filterDocNumber').value, // ใช้สำหรับค้นหาทั้งเลขที่และชื่อเรื่อง
    };
    
    showLoadingAlert('กำลังค้นหาเอกสาร...');
    
    // เรียก API พร้อมส่ง filters object ไปใน payload
    const result = await apiCall('digital_documents/digital_document_handler.php', { action: 'get', filters: filters });
    
    Swal.close();

    if(result.success) {
        currentPage.digitalDocuments = 1; // รีเซ็ตหน้ากลับไปที่ 1 ทุกครั้งที่ค้นหา
        allDigitalDocuments = result.documents; // อัปเดตข้อมูลทั้งหมดเป็นข้อมูลที่ค้นหาเจอ
        renderDigitalDocumentsTable(); // แสดงผลตารางจากข้อมูลที่อัปเดตแล้ว
    } else {
        showErrorAlert('ค้นหาไม่สำเร็จ', result.error);
        renderDigitalDocumentsTable([]); // แสดงตารางว่างเมื่อค้นหาไม่สำเร็จ
    }
}

// ฟังก์ชันสำหรับจัดการ Action ของตารางเอกสาร
async function handleDigitalDocumentActions(e) {
    const button = e.target.closest('.action-btn');
    if (!button) return;
    const id = button.closest('tr')?.dataset.id;
    const action = button.dataset.action;

    if (action === 'view_doc') {
        showDigitalDocumentDetailsModal(id);
    } else if (action === 'delete_doc') {
        Swal.fire({
            title: 'ยืนยันการลบเอกสาร?',
            text: "ไฟล์ทั้งหมดที่เกี่ยวข้องจะถูกลบอย่างถาวร!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'ใช่, ลบเลย!'
        }).then(async (result) => {
            if (result.isConfirmed) {
                showLoadingAlert('กำลังลบเอกสาร...');
                const res = await apiCall('digital_documents/digital_document_handler.php', { action: 'delete', docId: id });
                if (res.success) {
                    showSuccessAlert('สำเร็จ!', res.message).then(() => loadInitialData());
                } else {
                    Swal.close();
                    showErrorAlert('เกิดข้อผิดพลาด', res.error);
                }
            }
        });
    }
}
// --- END: ✨ เพิ่มฟังก์ชันใหม่ทั้งหมดสำหรับระบบเอกสาร ---

    function renderSchoolInfoForm() {
        const form = document.getElementById('school-info-form');
        if (!form) return;
        form.reset(); // Clear form
        form.classList.remove('was-validated');

        // Populate form fields
        document.getElementById('schoolId').value = schoolInfo.schoolId || '';
        document.getElementById('schoolName').value = schoolInfo.schoolName || '';
        document.getElementById('address').value = schoolInfo.address || '';
        document.getElementById('phone').value = schoolInfo.phone || '';
        document.getElementById('email').value = schoolInfo.email || '';
        document.getElementById('principalName').value = schoolInfo.principalName || '';

        // Handle logo display
        const logoPreview = document.getElementById('logoPreview');
        const logoFileNameSpan = document.getElementById('logoFileName');
        const removeLogoBtn = document.getElementById('removeLogoFileBtn');

        if (schoolInfo.logoUrl) {
            logoPreview.src = schoolInfo.logoUrl;
            logoPreview.style.display = 'block';
            logoFileNameSpan.textContent = `ไฟล์ปัจจุบัน: ${schoolInfo.logoUrl.split('/').pop()}`;
            removeLogoBtn.style.display = 'inline-block';
            selectedLogoFile = null; // No new file selected yet
        } else {
            logoPreview.src = '#';
            logoPreview.style.display = 'none';
            logoFileNameSpan.textContent = '';
            removeLogoBtn.style.display = 'none';
            selectedLogoFile = null;
        }
    }

    function renderAdminTable() {
        const tbody = document.getElementById('admin-table-body');
        if (!tbody) return;
        
        const page = currentPage.admin;
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedUsers = allUsers.slice(start, end);

        tbody.innerHTML = ''; 
        paginatedUsers.forEach((user, index) => {
            const sequenceNumber = start + index + 1;
            let actions = '';
            const resetBtn = user.resetStatus === 'pending' ? `<button class="btn btn-sm btn-info ms-1 action-btn" data-action="reset-password" data-id="${user.userId}" title="รีเซ็ตรหัสผ่าน"><i class="fas fa-key"></i></button>` : '';

            if (currentUser.role === 'admin') {
                if (user.role !== 'admin') {
                    actions += `<button class="btn btn-sm btn-warning me-1 action-btn" data-action="edit" data-id="${user.userId}" title="แก้ไข"><i class="fas fa-edit"></i></button>`;
                }
                if (currentUser.userId !== user.userId) {
                    actions += `<button class="btn btn-sm btn-danger action-btn" data-action="delete" data-id="${user.userId}" title="ลบ"><i class="fas fa-trash"></i></button>`;
                }
                actions += resetBtn;
            }

            const roleMap = { 'teacher': 'ครู/บุคลากร', 'principal': 'ผู้บริหาร', 'admin': 'ผู้ดูแลระบบ' };
            tbody.innerHTML += `<tr data-id="${user.userId}">
                <td>${sequenceNumber}</td>
                <td>${user.prefix}${user.name} ${user.surname}</td>
                <td>${user.employeeId || '-'}</td>
                <td>${user.position}</td>
                <td>${user.username}</td>
                <td><span class="badge bg-primary">${roleMap[user.role]}</span></td>
                <td>${actions}</td>
            </tr>`;
        });

        // ✨ FIX: ส่ง parent element (.card-body) ไปให้ renderPagination
        const parentElement = tbody.closest('.card-body');
        renderPagination('admin-pagination', 'admin', allUsers.length, parentElement);
    }
    
    function renderClassLevelTable() {
        const tbody = document.getElementById('class-level-table-body');
        if (!tbody) return;

        const page = currentPage.classLevel;
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedData = allClassLevels.slice(start, end);
        
        tbody.innerHTML = '';
        paginatedData.forEach((cl, index) => {
            const sequenceNumber = start + index + 1;
            const actions = (currentUser.role === 'admin' || currentUser.role === 'principal') ? `
                <button class="btn btn-sm btn-warning action-btn" data-action="edit" data-id="${cl.classLevelId}" title="แก้ไข"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger action-btn" data-action="delete" data-id="${cl.classLevelId}" title="ลบ"><i class="fas fa-trash"></i></button>
            ` : '';
            tbody.innerHTML += `<tr data-id="${cl.classLevelId}">
                <td>${sequenceNumber}</td>
                <td>${cl.className}</td>
                <td>${cl.description || '-'}</td>
                <td>${actions}</td>
            </tr>`;
        });
        
        const parentElement = tbody.closest('.card-body');
        renderPagination('class-level-pagination', 'classLevel', allClassLevels.length, parentElement);
    }

    function renderSubjectTable() {
        const tbody = document.getElementById('subject-table-body');
        if (!tbody) return;

        const page = currentPage.subject;
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedData = allSubjects.slice(start, end);

        tbody.innerHTML = '';
        paginatedData.forEach((subject, index) => {
            const sequenceNumber = start + index + 1;
            const actions = (currentUser.role === 'admin' || currentUser.role === 'principal') ? `
                <button class="btn btn-sm btn-warning action-btn" data-action="edit" data-id="${subject.subjectId}" title="แก้ไข"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger action-btn" data-action="delete" data-id="${subject.subjectId}" title="ลบ"><i class="fas fa-trash"></i></button>
            ` : '';
            
            let subjectTypeBadge = '';
            switch(subject.subjectType) {
                case 'วิชาพื้นฐาน': subjectTypeBadge = `<span class="badge bg-primary">${subject.subjectType}</span>`; break;
                case 'วิชาเพิ่มเติม': subjectTypeBadge = `<span class="badge bg-info text-dark">${subject.subjectType}</span>`; break;
                case 'วิชาเลือกเสรี': subjectTypeBadge = `<span class="badge bg-success">${subject.subjectType}</span>`; break;
                case 'กิจกรรมพัฒนาผู้เรียน': subjectTypeBadge = `<span class="badge bg-warning text-dark">${subject.subjectType}</span>`; break;
                default: subjectTypeBadge = `<span class="badge bg-secondary">${subject.subjectType || '-'}</span>`;
            }

            tbody.innerHTML += `<tr data-id="${subject.subjectId}">
                <td>${sequenceNumber}</td>
                <td>${subject.subjectCode}</td>
                <td>${subject.subjectName}</td>
                <td>${subjectTypeBadge}</td> 
                <td>${subject.credits || '-'}</td>
                <td>${actions}</td>
            </tr>`;
        });

        const parentElement = tbody.closest('.card-body');
        renderPagination('subject-pagination', 'subject', allSubjects.length, parentElement);
    }

     function renderStudentTable(studentsToRender = allStudents) {
        const tbody = document.getElementById('student-table-body');
        if (!tbody) return;

        const page = currentPage.student;
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedData = studentsToRender.slice(start, end);

        tbody.innerHTML = '';
        if (paginatedData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="9" class="text-center">ไม่พบข้อมูลนักเรียน</td></tr>`;
        } else {
            paginatedData.forEach((student, index) => {
                const sequenceNumber = start + index + 1;
                const actions = (currentUser.role === 'admin' || currentUser.role === 'principal') ? `
                    <button class="btn btn-sm btn-warning action-btn" data-action="edit" data-id="${student.studentId}" title="แก้ไข"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-danger action-btn ms-1" data-action="delete" data-id="${student.studentId}" title="ลบ"><i class="fas fa-trash"></i></button>
                ` : '';

                tbody.innerHTML += `<tr data-id="${student.studentId}">
                    <td>${sequenceNumber}</td>
                    <td>${student.studentCode}</td>
                    <td>${student.prefix}${student.name} ${student.surname}</td>
                    <td>${student.gender || '-'}</td>
                    <td>${student.grade || '-'}</td>
                    <td>${student.class || '-'}</td>
                    <td>${student.parentName || '-'}</td>
                    <td>${student.parentPhone || '-'}</td>
                    <td>${actions}</td>
                </tr>`;
            });
        }
        
        const parentElement = tbody.closest('.card-body');
        renderPagination('student-pagination', 'student', studentsToRender.length, parentElement);
    }

    // --- START: ✨ โค้ดใหม่สำหรับ Import/Export และ Filter นักเรียน ---

    // 1. ฟังก์ชันสำหรับดาวน์โหลดเทมเพลต CSV
    function downloadStudentTemplate() {
        // หัวคอลัมน์ภาษาไทย
        const thaiHeaders = [
            "รหัสนักเรียน", "คำนำหน้า", "ชื่อ", "นามสกุล", 
            "วันเกิด(YYYY-MM-DD)", "เพศ(ชาย/หญิง)", "ระดับชั้น", "ห้อง", 
            "ชื่อผู้ปกครอง", "เบอร์โทรผู้ปกครอง"
        ];

        // ข้อมูลตัวอย่าง 1 แถว
        const exampleRow = [
            "67001", "เด็กชาย", "ตัวอย่าง", "นักเรียน",
            "2015-10-25", "ชาย", "ประถมศึกษาปีที่ 1", "1",
            "นายสมชาย ตัวอย่าง", "0812345678"
        ];

        // สร้างเนื้อหา CSV โดยมีหัวคอลัมน์และข้อมูลตัวอย่าง
        let csvContent = thaiHeaders.join(",") + "\n" + exampleRow.join(",");

        // เพิ่ม BOM (\uFEFF) เพื่อให้ Excel เปิดไฟล์ภาษาไทยได้ถูกต้อง
        const fullCsvContent = "data:text/csv;charset=utf-8,\uFEFF" + encodeURI(csvContent);
        
        const link = document.createElement("a");
        link.setAttribute("href", fullCsvContent);
        link.setAttribute("download", "student_template.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // 2. ฟังก์ชันสำหรับจัดการการนำเข้าไฟล์ CSV
     async function handleStudentImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const headerMapping = {
            "รหัสนักเรียน": "studentCode", "คำนำหน้า": "prefix", "ชื่อ": "name", 
            "นามสกุล": "surname", "วันเกิด(YYYY-MM-DD)": "dateOfBirth", "เพศ(ชาย/หญิง)": "gender", 
            "ระดับชั้น": "grade", "ห้อง": "class", "ชื่อผู้ปกครอง": "parentName", "เบอร์โทรผู้ปกครอง": "parentPhone"
        };

        showLoadingAlert('กำลังตรวจสอบไฟล์...');

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const text = e.target.result;
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
                if (lines.length < 2) {
                    throw new Error('ไฟล์ CSV ต้องมีอย่างน้อยหนึ่งบรรทัดสำหรับข้อมูล (ไม่นับหัวคอลัมน์)');
                }

                const fileHeaders = lines.shift().trim().split(',').map(h => h.trim());
                const students = lines.map(line => {
                    const values = line.split(',');
                    const student = {};
                    fileHeaders.forEach((header, index) => {
                        const englishKey = headerMapping[header];
                        if (englishKey) {
                            student[englishKey] = values[index] ? values[index].trim() : '';
                        }
                    });
                    return student;
                }).filter(s => s.studentCode);

                if (students.length === 0) {
                    throw new Error('ไม่พบข้อมูลนักเรียนที่ถูกต้องในไฟล์');
                }

                // --- START: ✨ ส่วนที่เพิ่มเข้ามาสำหรับการตรวจสอบรหัสซ้ำ ---
                const codesInFile = students.map(s => s.studentCode);
                const existingCodes = new Set(allStudents.map(s => s.studentCode));

                // 1. ตรวจสอบรหัสซ้ำภายในไฟล์ CSV เอง
                const duplicateCodesInFile = codesInFile.filter((code, index) => codesInFile.indexOf(code) !== index);
                if (duplicateCodesInFile.length > 0) {
                    throw new Error(`พบรหัสนักเรียนซ้ำกันในไฟล์ CSV: ${[...new Set(duplicateCodesInFile)].join(', ')}`);
                }

                // 2. ตรวจสอบรหัสซ้ำกับข้อมูลที่มีอยู่ในระบบแล้ว
                const duplicateCodesInSystem = codesInFile.filter(code => existingCodes.has(code));
                if (duplicateCodesInSystem.length > 0) {
                    throw new Error(`พบรหัสนักเรียนที่ซ้ำกับข้อมูลในระบบ: ${duplicateCodesInSystem.join(', ')}`);
                }
                // --- END: ✨ ส่วนที่เพิ่มเข้ามา ---

                showLoadingAlert('กำลังนำเข้าข้อมูล...'); // เปลี่ยนข้อความเมื่อตรวจสอบผ่าน
                const result = await apiCall('student_handler.php', { action: 'import', students: students });
                
                if (result.success) {
                    await showSuccessAlert('สำเร็จ!', result.message);
                    loadInitialData();
                } else {
                    showErrorAlert('นำเข้าไม่สำเร็จ', result.error);
                }

            } catch (error) {
                showErrorAlert('เกิดข้อผิดพลาด', error.message);
            }
        };
        reader.onerror = () => {
             showErrorAlert('เกิดข้อผิดพลาด', 'ไม่สามารถอ่านไฟล์ได้');
        }
        reader.readAsText(new Blob([file], { type: "text/csv;charset=utf-8;" }));
        
        event.target.value = '';
    }

    // 3. ฟังก์ชันสำหรับกรองข้อมูลและแสดงผลตารางใหม่
    function filterAndRenderStudents() {
        const selectedGrade = document.getElementById('filterStudentGrade').value;
        const selectedClass = document.getElementById('filterStudentClass').value;

        // เริ่มต้นด้วยข้อมูลทั้งหมด แล้วกรองตามเงื่อนไข
        let filteredStudents = allStudents;

        if (selectedGrade) {
            filteredStudents = filteredStudents.filter(s => s.grade === selectedGrade);
        }
        if (selectedClass) {
            filteredStudents = filteredStudents.filter(s => s.class === selectedClass);
        }

        // รีเซ็ตหน้าเป็น 1 ก่อนแสดงผลการค้นหาใหม่
        currentPage.student = 1; 
        renderStudentTable(filteredStudents);
    }
    // --- END: ✨ โค้ดใหม่ ---

    function renderSupervisionTable() {
        const tbody = document.getElementById('supervision-table-body');
        if (!tbody) return;

        const page = currentPage.supervision;
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedData = allSupervisionRecords.slice(start, end);

        tbody.innerHTML = '';
        paginatedData.forEach((rec, index) => {
            const sequenceNumber = start + index + 1;
            let fileIcon = '';
            if (rec.resultFiles && rec.resultFiles.length > 0) {
                const file = rec.resultFiles[0];
                const fileExtension = file.fileUrl ? file.fileUrl.split('.').pop().toLowerCase() : '';
                let iconClass = 'fa-file';
                if (fileExtension === 'pdf') iconClass = 'fa-file-pdf';
                else if (fileExtension === 'doc' || fileExtension === 'docx') iconClass = 'fa-file-word';
                fileIcon = `<a href="${file.fileUrl}" target="_blank" class="text-primary me-2" title="ดูผลการนิเทศ"><i class="fas ${iconClass}"></i></a>`;
            }

            let photoIcons = '';
            if (rec.photos && rec.photos.length > 0) {
                photoIcons = rec.photos.map(photo => `<a href="${photo.photoUrl}" target="_blank" class="text-info me-1" title="ดูรูปภาพประกอบ"><i class="fas fa-image"></i></a>`).join('');
            }
            
            let actions = '';
            const canManage = currentUser && (currentUser.role === 'admin' || currentUser.role === 'principal' || (currentUser.role === 'teacher' && currentUser.permissions && currentUser.permissions.includes('academic-management')));
            if (canManage) {
                actions = `<button class="btn btn-sm btn-warning action-btn" data-action="edit" data-id="${rec.recordId}" title="แก้ไข"><i class="fas fa-edit"></i></button>
                           <button class="btn btn-sm btn-danger action-btn ms-1" data-action="delete" data-id="${rec.recordId}" title="ลบ"><i class="fas fa-trash"></i></button>`;
            }

            tbody.innerHTML += `<tr data-id="${rec.recordId}">
                <td>${sequenceNumber}</td>
                <td>${formatDate(rec.supervisionDate)}</td>
                <td>${rec.supervisorName}</td>
                <td>${rec.superviseeName}</td>
                <td>${rec.focusArea || '-'}</td>
                <td>${rec.status}</td>
                <td>${fileIcon} ${photoIcons} ${actions}</td>
            </tr>`;
        });

        const parentElement = tbody.closest('.card-body');
        renderPagination('supervision-pagination', 'supervision', allSupervisionRecords.length, parentElement);
    }

    function renderTimetableTable() {
        const tbody = document.getElementById('timetable-table-body');
        if (!tbody) return;

        const academicYearFilter = document.getElementById('filterAcademicYear').value;
        const semesterFilter = document.getElementById('filterSemester').value;
        const filteredEntries = allTimetableEntries.filter(entry => {
            const matchesYear = academicYearFilter ? entry.academicYear === academicYearFilter : true;
            const matchesSemester = semesterFilter ? entry.semester === semesterFilter : true;
            return matchesYear && matchesSemester;
        });
        
        const page = currentPage.timetable;
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedData = filteredEntries.slice(start, end);

        tbody.innerHTML = '';
        const dayMap = { 'Monday': 'จันทร์', 'Tuesday': 'อังคาร', 'Wednesday': 'พุธ', 'Thursday': 'พฤหัสบดี', 'Friday': 'ศุกร์', 'Saturday': 'เสาร์', 'Sunday': 'อาทิตย์' };
        
        paginatedData.forEach((entry, index) => {
            const sequenceNumber = start + index + 1;
            let actions = '';
            const canManageTimetable = currentUser && (currentUser.role === 'admin' || currentUser.role === 'principal' || (currentUser.role === 'teacher' && currentUser.permissions && currentUser.permissions.includes('academic-management')));

            if (canManageTimetable) {
                actions = `<button class="btn btn-sm btn-warning action-btn" data-action="edit" data-id="${entry.entryId}" title="แก้ไข"><i class="fas fa-edit"></i></button>
                           <button class="btn btn-sm btn-danger action-btn ms-1" data-action="delete" data-id="${entry.entryId}" title="ลบ"><i class="fas fa-trash"></i></button>`;
            }

            tbody.innerHTML += `<tr data-id="${entry.entryId}">
                <td>${sequenceNumber}</td>
                <td>${entry.academicYear || '-'} / ${entry.semester || '-'}</td>
                <td>${entry.classLevelName || '-'}</td>
                <td>${entry.subjectCode || '-'} ${entry.subjectName || '-'}</td>
                <td>${entry.teacherName || '-'}</td>
                <td>${entry.studentName || '-'} (${entry.studentCode || '-'})</td>
                <td>${dayMap[entry.dayOfWeek] || entry.dayOfWeek}</td>
                <td>${entry.startTime || '-'} - ${entry.endTime || '-'}</td>
                <td>${entry.room || '-'}</td>
                <td>${actions}</td>
            </tr>`;
        });
        
        const parentElement = tbody.closest('.card-body');
        renderPagination('timetable-pagination', 'timetable', filteredEntries.length, parentElement);
    }


    // --- NEW: Render All Settings Tables ---
    function renderSettingsTables() {
        renderAcademicTermsTable();
        renderFiscalYearsTable();
        renderHolidaysTable();
    }

    function renderAcademicTermsTable() {
        const tbody = document.getElementById('academic-terms-table-body');
        if (!tbody) return;

        const page = currentPage.academicTerms;
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedData = allSettings.academicTerms.slice(start, end);

        tbody.innerHTML = '';
        paginatedData.forEach((term, index) => {
            const sequenceNumber = start + index + 1;
            const isCurrentBadge = term.isCurrent ? `<span class="badge bg-success">ปัจจุบัน</span>` : '';
            const actions = `
                <button class="btn btn-sm btn-info me-1 action-btn" data-action="set_current_term" data-id="${term.termId}" title="ตั้งเป็นปัจจุบัน"><i class="fas fa-check-circle"></i></button>
                <button class="btn btn-sm btn-warning me-1 action-btn" data-action="edit_term" data-id="${term.termId}" title="แก้ไข"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger action-btn" data-action="delete_term" data-id="${term.termId}" title="ลบ"><i class="fas fa-trash"></i></button>
            `;
            tbody.innerHTML += `<tr data-id="${term.termId}">
                <td>${sequenceNumber}</td>
                <td>${term.academicYear}</td>
                <td>${term.semester}</td>
                <td>${formatDate(term.startDate)}</td>
                <td>${formatDate(term.endDate)}</td>
                <td>${isCurrentBadge}</td>
                <td>${actions}</td>
            </tr>`;
        });

        const parentElement = tbody.closest('.tab-pane');
        renderPagination('academic-terms-pagination', 'academicTerms', allSettings.academicTerms.length, parentElement);
    }


    function renderFiscalYearsTable() {
        const tbody = document.getElementById('fiscal-years-table-body');
        if (!tbody) return;

        const page = currentPage.fiscalYears;
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedData = allSettings.fiscalYears.slice(start, end);

        tbody.innerHTML = '';
        paginatedData.forEach((fy, index) => {
            const sequenceNumber = start + index + 1;
            const isCurrentBadge = fy.isCurrent ? `<span class="badge bg-success">ปัจจุบัน</span>` : '';
            const actions = `
                <button class="btn btn-sm btn-info me-1 action-btn" data-action="set_current_fy" data-id="${fy.fiscalYearId}" title="ตั้งเป็นปัจจุบัน"><i class="fas fa-check-circle"></i></button>
                <button class="btn btn-sm btn-warning me-1 action-btn" data-action="edit_fy" data-id="${fy.fiscalYearId}" title="แก้ไข"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger action-btn" data-action="delete_fy" data-id="${fy.fiscalYearId}" title="ลบ"><i class="fas fa-trash"></i></button>
            `;
            tbody.innerHTML += `<tr data-id="${fy.fiscalYearId}">
                <td>${sequenceNumber}</td>
                <td>${fy.year}</td>
                <td>${formatDate(fy.startDate)}</td>
                <td>${formatDate(fy.endDate)}</td>
                <td>${isCurrentBadge}</td>
                <td>${actions}</td>
            </tr>`;
        });
        
        const parentElement = tbody.closest('.tab-pane');
        renderPagination('fiscal-years-pagination', 'fiscalYears', allSettings.fiscalYears.length, parentElement);
    }

    function renderHolidaysTable() {
        const tbody = document.getElementById('holidays-table-body');
        if (!tbody) return;
        
        const page = currentPage.holidays;
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        const paginatedData = allSettings.holidays.slice(start, end);

        tbody.innerHTML = '';
        paginatedData.forEach((holiday, index) => {
            const sequenceNumber = start + index + 1;
            const actions = `
                <button class="btn btn-sm btn-warning me-1 action-btn" data-action="edit_holiday" data-id="${holiday.holidayId}" title="แก้ไข"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-danger action-btn" data-action="delete_holiday" data-id="${holiday.holidayId}" title="ลบ"><i class="fas fa-trash"></i></button>
            `;
            
            tbody.innerHTML += `<tr data-id="${holiday.holidayId}">
                <td>${sequenceNumber}</td>
                <td>${holiday.description}</td>
                <td>${formatDate(holiday.startDate)}</td>
                <td>${formatDate(holiday.endDate)}</td>
                <td>${holiday.fiscalYear || '-'}</td>
                <td>${actions}</td>
            </tr>`;
        });
        
        const parentElement = tbody.closest('.tab-pane');
        renderPagination('holidays-pagination', 'holidays', allSettings.holidays.length, parentElement);
    }

    // --- FORM & MODAL HANDLERS ---
    async function handleSchoolInfoSubmit(e) {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) return;
        showLoadingAlert('กำลังบันทึกข้อมูลโรงเรียน...');

        let logoUrl = schoolInfo.logoUrl || ''; // Keep existing URL if no new file is selected

        if (selectedLogoFile) {
            const formData = new FormData();
            formData.append('attachmentFile', selectedLogoFile);
            try {
                const uploadResponse = await fetch('api/upload_file.php', { method: 'POST', body: formData });
                const uploadResult = await uploadResponse.json();
                if (!uploadResult.success) { throw new Error(uploadResult.error); }
                logoUrl = uploadResult.url;
            } catch (error) { showErrorAlert('อัปโหลดโลโก้ไม่สำเร็จ', error.message); return; }
        }

        const payload = {
            action: 'update', // Always 'update' for school info, handles insert if no ID exists
            schoolInfo: {
                schoolId: document.getElementById('schoolId').value,
                schoolName: document.getElementById('schoolName').value,
                address: document.getElementById('address').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                principalName: document.getElementById('principalName').value,
                logoUrl: logoUrl
            }
        };

        const result = await apiCall('school_handler.php', payload);
        if (result.success) {
            showSuccessAlert('สำเร็จ!', result.message).then(() => loadInitialData());
        } else {
            Swal.close();
            showErrorAlert('เกิดข้อผิดพลาด', result.error);
        }
    }

async function handleUserFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) return;
        showLoadingAlert('กำลังบันทึกข้อมูลผู้ใช้งาน...');
        
        const userId = document.getElementById('editUserId').value;
        const isEditing = !!userId;
        const targetRole = document.getElementById('userRole').value;

        // ✨ FIX: รวบรวมข้อมูล permissions
        let permissions = [];
        if (targetRole === 'teacher') {
            document.querySelectorAll('#teacherPermissionsSection .form-check-input:checked').forEach(checkbox => {
                permissions.push(checkbox.value);
            });
        }

        const payload = {
            action: isEditing ? 'update' : 'add',
            userData: {
                userId: userId,
                prefix: document.getElementById('userPrefix').value,
                name: document.getElementById('userName').value,
                surname: document.getElementById('userSurname').value,
                employeeId: document.getElementById('userEmployeeId').value || null,
                position: document.getElementById('userPosition').value,
                phone: document.getElementById('userPhone').value || null,
                email: document.getElementById('userEmail').value || null,
                username: document.getElementById('userUsername').value,
                password: document.getElementById('userPassword').value,
                role: targetRole,
                permissions: permissions // ✨ FIX: เพิ่ม permissions เข้าไปใน payload
            }
        };

        const result = await apiCall('admin_handler.php', payload);
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            showSuccessAlert('สำเร็จ!', result.message).then(() => loadInitialData());
        } else {
            Swal.close();
            showErrorAlert('เกิดข้อผิดพลาด', result.error);
        }
    }

    // NEW: Handle Class Level Form Submit
    async function handleClassLevelFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) return;
        showLoadingAlert('กำลังบันทึกข้อมูลระดับชั้น...');

        const classLevelId = document.getElementById('editClassLevelId').value;
        const isEditing = !!classLevelId;

        const payload = {
            action: isEditing ? 'update' : 'add',
            classData: {
                classLevelId: classLevelId,
                className: document.getElementById('className').value,
                description: document.getElementById('classDescription').value || null
            }
        };

        const result = await apiCall('class_level_handler.php', payload);
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('classLevelModal')).hide();
            showSuccessAlert('สำเร็จ!', result.message).then(() => loadInitialData());
        } else {
            Swal.close();
            showErrorAlert('เกิดข้อผิดพลาด', result.error);
        }
    }

// ฟังก์ชันสำหรับจัดการการบันทึกข้อมูลรายวิชา
async function handleSubjectFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    if (!form.checkValidity()) return;
    showLoadingAlert('กำลังบันทึกข้อมูลรายวิชา...');

    const subjectId = document.getElementById('editSubjectId').value;
    const isEditing = !!subjectId;

    // ✨ FIX: เพิ่ม subjectType ใน payload
    const payload = {
        action: isEditing ? 'update' : 'add',
        subjectData: {
            subjectId: subjectId,
            subjectCode: document.getElementById('subjectCode').value,
            subjectName: document.getElementById('subjectName').value,
            credits: document.getElementById('subjectCredits').value,
            subjectType: document.getElementById('subjectType').value
        }
    };
    
    const result = await apiCall('subject_handler.php', payload);
    if (result.success) {
        bootstrap.Modal.getInstance(document.getElementById('subjectModal')).hide();
        showSuccessAlert('สำเร็จ!', result.message).then(() => loadInitialData());
    } else {
        Swal.close();
        showErrorAlert('เกิดข้อผิดพลาด', result.error);
    }
}
    async function handleStudentFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) return;
        showLoadingAlert('กำลังบันทึกข้อมูลนักเรียน...');
        
        const studentId = document.getElementById('editStudentId').value;
        const isEditing = !!studentId;

        const payload = {
            action: isEditing ? 'update' : 'add',
            studentData: {
                studentId: studentId,
                studentCode: document.getElementById('studentCode').value,
                prefix: document.getElementById('studentPrefix').value,
                name: document.getElementById('studentName').value,
                surname: document.getElementById('studentSurname').value,
                dateOfBirth: document.getElementById('studentDateOfBirth').value || null,
                gender: document.getElementById('studentGender').value || null,
                grade: document.getElementById('studentGrade').value || null, // Now from dropdown
                class: document.getElementById('studentClass').value || null,
                parentName: document.getElementById('parentName').value || null,
                parentPhone: document.getElementById('parentPhone').value || null
            }
        };

        const result = await apiCall('student_handler.php', payload);
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('studentModal')).hide();
            showSuccessAlert('สำเร็จ!', result.message).then(() => loadInitialData());
        } else {
            Swal.close();
            showErrorAlert('เกิดข้อผิดพลาด', result.error);
        }
    }

    // NEW: Handle Supervision Form Submit
 async function handleSupervisionFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) return;
        showLoadingAlert('กำลังบันทึกและอัปโหลดไฟล์...');
        
        const recordId = document.getElementById('editSupervisionRecordId').value;
        const isEditing = !!recordId;

        try {
            // --- ✨ FIX START: ปรับปรุงตรรกะการจัดการไฟล์ทั้งหมด ---

            // ส่วนที่ 1: จัดการไฟล์ผลการนิเทศ (PDF)
            let finalResultFileInfo = [];
            if (currentSupervisionResultFile) {
                if (currentSupervisionResultFile.file) { // ถ้ามีการเลือกไฟล์ใหม่
                    const uploadRes = await uploadFileToServer(currentSupervisionResultFile.file, 'result');
                    if (!uploadRes.success) throw new Error(`อัปโหลดไฟล์ผลการนิเทศไม่สำเร็จ: ${uploadRes.error}`);
                    finalResultFileInfo.push({
                        fileId: uploadRes.fileId,
                        fileName: uploadRes.fileName,
                        fileUrl: uploadRes.url,
                        fileType: uploadRes.fileType
                    });
                } else if (currentSupervisionResultFile.fileUrl) { // ถ้าเป็นไฟล์เดิมที่ไม่ได้แก้ไข
                    finalResultFileInfo.push(currentSupervisionResultFile);
                }
            }

            // ส่วนที่ 2: จัดการไฟล์รูปภาพประกอบ
            let finalPhotoFilesInfo = [];
            // วนลูปสร้าง Promise สำหรับอัปโหลดไฟล์ใหม่ทั้งหมดก่อน
            const uploadPromises = currentSupervisionPhotoFiles
                .filter(photo => photo.file) // กรองเอารูปใหม่ที่ต้องอัปโหลด
                .map(photo => uploadFileToServer(photo.file, 'photo'));
            
            const uploadedPhotos = await Promise.all(uploadPromises);

            // ตรวจสอบว่ามีข้อผิดพลาดจากการอัปโหลดหรือไม่
            const firstError = uploadedPhotos.find(res => !res.success);
            if (firstError) {
                throw new Error(`อัปโหลดรูปประกอบไม่สำเร็จ: ${firstError.error}`);
            }
            
            // รวมข้อมูลไฟล์รูปภาพทั้งหมด (ทั้งเก่าและใหม่)
            const newPhotoInfo = uploadedPhotos.map(res => ({
                photoId: res.fileId,
                photoName: res.fileName,
                photoUrl: res.url,
                photoType: res.fileType
            }));
            
            const existingPhotoInfo = currentSupervisionPhotoFiles.filter(photo => photo.photoUrl); // กรองเอารูปเก่าที่ยังอยู่

            finalPhotoFilesInfo = [...existingPhotoInfo, ...newPhotoInfo];

            // --- ✨ FIX END ---

            const payload = {
                action: isEditing ? 'update' : 'add',
                recordData: {
                    recordId: recordId,
                    supervisionDate: document.getElementById('supervisionDate').value,
                    supervisorId: document.getElementById('supervisorId').value,
                    superviseeId: document.getElementById('superviseeId').value,
                    focusArea: document.getElementById('focusArea').value || null,
                    observations: document.getElementById('observations').value || null,
                    feedback: document.getElementById('feedback').value || null,
                    followUp: document.getElementById('followUp').value || null,
                    status: document.getElementById('supervisionStatus').value || 'Completed'
                },
                resultFiles: finalResultFileInfo, // ส่งข้อมูลไฟล์ PDF ที่ถูกต้อง
                photoFiles: finalPhotoFilesInfo // ส่งข้อมูลรูปภาพทั้งหมดที่ถูกต้อง
            };

            const result = await apiCall('supervision/supervision_handler.php', payload);
            if (result.success) {
                bootstrap.Modal.getInstance(document.getElementById('supervisionModal')).hide();
                showSuccessAlert('สำเร็จ!', result.message).then(() => loadInitialData());
            } else {
                throw new Error(result.error);
            }
        } catch (error) {
            Swal.close();
            showErrorAlert('เกิดข้อผิดพลาด', error.message);
        }
    }

  // ฟังก์ชันสำหรับจัดการการบันทึกข้อมูลตารางสอน
async function handleTimetableFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }
    showLoadingAlert('กำลังบันทึกตารางสอน...');

    const entryId = document.getElementById('editTimetableEntryId').value;
    const isEditing = !!entryId;
    
    const subjectId = document.getElementById('timetableSubject').value;
    const subject = timetableDropdownData.subjects.find(s => s.subjectId === subjectId);

    // สร้างข้อมูลที่จะส่งไป (Payload)
    const payload = {
        action: isEditing ? 'update' : 'add',
        timetableData: {
            entryId: entryId,
            academicYear: document.getElementById('timetableAcademicYear').value,
            semester: document.getElementById('timetableSemester').value,
            classLevelId: document.getElementById('timetableClassLevel').value,
            subjectId: subjectId,
            teacherId: document.getElementById('timetableTeacher').value,
            dayOfWeek: document.getElementById('timetableDayOfWeek').value,
            startTime: document.getElementById('timetableStartTime').value,
            endTime: document.getElementById('timetableEndTime').value,
            // ✨ FIX: ส่งข้อมูลนักเรียน/ห้องเรียนตามประเภทวิชา
            room: null,
            studentIds: []
        }
    };

    if (subject && subject.subjectType === 'วิชาเลือกเสรี') {
        const studentSelect = document.getElementById('timetableStudent');
        // รวบรวม ID นักเรียนทั้งหมดที่ถูกเลือก (สำหรับวิชาเลือก)
        payload.timetableData.studentIds = Array.from(studentSelect.selectedOptions).map(option => option.value);
    } else {
        // ส่งค่าห้องเรียน (สำหรับวิชาปกติ)
        payload.timetableData.room = document.getElementById('timetableRoom').value;
    }

    const result = await apiCall('academic/timetable_handler.php', payload);
    if (result.success) {
        bootstrap.Modal.getInstance(document.getElementById('timetableModal')).hide();
        showSuccessAlert('สำเร็จ!', result.message).then(() => loadInitialData());
    } else {
        Swal.close();
        showErrorAlert('เกิดข้อผิดพลาด', result.error);
    }
}

    // --- NEW: Handlers for Settings Forms ---
    async function handleAcademicTermFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) return;
        showLoadingAlert('กำลังบันทึก...');
        const termId = document.getElementById('editTermId').value;
        const payload = {
            entity: 'academic_term',
            action: termId ? 'update' : 'add',
            data: {
                termId: termId,
                academicYear: document.getElementById('academicYear').value,
                semester: document.getElementById('semester').value,
                startDate: document.getElementById('termStartDate').value,
                endDate: document.getElementById('termEndDate').value
            }
        };
        const result = await apiCall('settings_handler.php', payload);
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('academicTermModal')).hide();
            showSuccessAlert('สำเร็จ!', result.message).then(loadInitialData);
        } else {
            Swal.close();
            showErrorAlert('เกิดข้อผิดพลาด', result.error);
        }
    }

    async function handleFiscalYearFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) return;
        showLoadingAlert('กำลังบันทึก...');
        const fiscalYearId = document.getElementById('editFiscalYearId').value;
        const payload = {
            entity: 'fiscal_year',
            action: fiscalYearId ? 'update' : 'add',
            data: {
                fiscalYearId: fiscalYearId,
                year: document.getElementById('fiscalYear').value,
                startDate: document.getElementById('fiscalStartDate').value,
                endDate: document.getElementById('fiscalEndDate').value
            }
        };
        const result = await apiCall('settings_handler.php', payload);
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('fiscalYearModal')).hide();
            showSuccessAlert('สำเร็จ!', result.message).then(loadInitialData);
        } else {
            Swal.close();
            showErrorAlert('เกิดข้อผิดพลาด', result.error);
        }
    }

// ✨ NEW: handleHolidayFormSubmit function
async function handleHolidayFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    if (!form.checkValidity()) return;
    
    const startDate = document.getElementById('holidayStartDate').value;
    const endDate = document.getElementById('holidayEndDate').value;

    if (new Date(endDate) < new Date(startDate)) {
        showErrorAlert('ข้อมูลไม่ถูกต้อง', 'วันที่สิ้นสุดต้องไม่น้อยกว่าวันที่เริ่มต้น');
        return;
    }

    showLoadingAlert('กำลังบันทึก...');
    const holidayId = document.getElementById('editHolidayId').value;
    const payload = {
        entity: 'holiday',
        action: holidayId ? 'update' : 'add',
        data: {
            holidayId: holidayId,
            fiscalYearId: document.getElementById('holidayFiscalYear').value,
            description: document.getElementById('holidayDescription').value,
            startDate: startDate,
            endDate: endDate
        }
    };
    const result = await apiCall('settings_handler.php', payload);
    if (result.success) {
        bootstrap.Modal.getInstance(document.getElementById('holidayModal')).hide();
        showSuccessAlert('สำเร็จ!', result.message).then(loadInitialData);
    } else {
        Swal.close();
        showErrorAlert('เกิดข้อผิดพลาด', result.error);
    }
}

    // --- MODAL DISPLAY FUNCTIONS ---
    function showAddModal(modalId, titleId, titleText, saveBtnId, saveBtnText, idField) {
        const modalEl = document.getElementById(modalId);
        if (!modalEl) return;
        const modal = new bootstrap.Modal(modalEl);
        const form = modalEl.querySelector('form');
        form.reset();
        form.classList.remove('was-validated');
        document.getElementById(titleId).textContent = titleText;
        document.getElementById(saveBtnId).innerHTML = `<i class="fas fa-save me-2"></i>${saveBtnText}`;
        if(idField) document.getElementById(idField).value = '';

        // NEW LOGIC FOR userRoleSelect: Only for userModal
        if (modalId === 'userModal') {
            const userRoleSelect = document.getElementById('userRole');
            const adminOption = userRoleSelect.querySelector('option[value="admin"]');
            const editUserId = document.getElementById('editUserId').value; // Check if it's an edit operation

            if (!editUserId && adminOption) { // If it's an ADD operation and admin option exists
                adminOption.remove(); // Remove admin option to prevent adding new admins
            } else if (editUserId && !adminOption && currentUser.role === 'admin') { 
                // If it's an EDIT operation, and current user is admin, AND admin option is missing (due to previous ADD modal state), re-add it.
                // This ensures admin can see/manage existing admin roles during edit if needed.
                const newAdminOption = document.createElement('option');
                newAdminOption.value = 'admin';
                newAdminOption.textContent = 'ผู้ดูแลระบบ (Admin)';
                userRoleSelect.appendChild(newAdminOption);
            }
        }
        
        modal.show();
    }
    
    function showAddUserModal() { 
        showAddModal('userModal', 'userModalTitle', 'เพิ่มผู้ใช้งานใหม่', 'saveUserBtn', 'บันทึก', 'editUserId');
        document.getElementById('userRole').value = 'teacher';
        document.getElementById('userPassword').required = true;

        // ✨ FIX: จัดการการแสดงผลของส่วน permissions
        const userRoleSelect = document.getElementById('userRole');
        const permissionsSection = document.getElementById('teacherPermissionsSection');
        
        // ฟังก์ชันสำหรับสลับการแสดงผล
        const togglePermissions = () => {
            permissionsSection.style.display = userRoleSelect.value === 'teacher' ? 'block' : 'none';
        };

        // ล้างค่าเก่าและผูก event listener
        document.querySelectorAll('#teacherPermissionsSection .form-check-input').forEach(c => c.checked = false);
        userRoleSelect.removeEventListener('change', togglePermissions); // ลบ listener เก่ากันซ้ำ
        userRoleSelect.addEventListener('change', togglePermissions);
        togglePermissions(); // เรียกครั้งแรกเพื่อตั้งค่าการแสดงผล
    }

    // NEW: Show Add/Edit Class Level Modal
    function showAddClassLevelModal() {
        showAddModal('classLevelModal', 'classLevelModalTitle', 'เพิ่มระดับชั้นใหม่', 'saveClassLevelBtn', 'บันทึก', 'editClassLevelId');
    }

    // NEW: Show Add/Edit Subject Modal
    function showAddSubjectModal() {
        showAddModal('subjectModal', 'subjectModalTitle', 'เพิ่มรายวิชาใหม่', 'saveSubjectBtn', 'บันทึก', 'editSubjectId');
    }

    function showAddStudentModal() {
        showAddModal('studentModal', 'studentModalTitle', 'เพิ่มนักเรียนใหม่', 'saveStudentBtn', 'บันทึก', 'editStudentId');
        // Populate class level dropdown
        const studentGradeSelect = document.getElementById('studentGrade');
        studentGradeSelect.innerHTML = '<option value="">-- เลือกระดับชั้น --</option>'; // Reset options
        allClassLevels.forEach(cl => {
            const option = document.createElement('option');
            option.value = cl.className;
            option.textContent = cl.className;
            studentGradeSelect.appendChild(option);
        });
    }

    // NEW: Show Add/Edit Supervision Modal
function showAddSupervisionModal() {
        showAddModal('supervisionModal', 'supervisionModalTitle', 'เพิ่มบันทึกการนิเทศใหม่', 'saveSupervisionBtn', 'บันทึก', 'editSupervisionRecordId');
        
        document.getElementById('supervisionResultFile').value = '';
        document.getElementById('supervisionPhotoFiles').value = '';
        currentSupervisionResultFile = null;
        currentSupervisionPhotoFiles = [];
        renderResultFilePreview();
        renderPhotoFilePreviews();

        const supervisorSelect = document.getElementById('supervisorId');
        const superviseeSelect = document.getElementById('superviseeId');
        
        supervisorSelect.innerHTML = '<option value="">-- เลือกผู้นิเทศ --</option>';
        superviseeSelect.innerHTML = '<option value="">-- เลือกผู้ถูกนิเทศ --</option>';

        const roleMap = { 'teacher': 'ครู/บุคลากร', 'principal': 'ผู้บริหาร', 'admin': 'ผู้ดูแลระบบ' };

        // ✨ FIX: กรองรายชื่อผู้นิเทศ (ไม่เอา admin)
        const supervisors = allUsers.filter(u => u.role !== 'admin');
        supervisors.forEach(user => {
            const option = document.createElement('option');
            option.value = user.userId;
            option.textContent = `${user.prefix}${user.name} ${user.surname} (${roleMap[user.role] || user.role})`;
            supervisorSelect.appendChild(option);
        });

        // ✨ FIX: กรองรายชื่อผู้ถูกนิเทศ (เอาเฉพาะ teacher)
        const supervisees = allUsers.filter(u => u.role === 'teacher');
        supervisees.forEach(user => {
            const option = document.createElement('option');
            option.value = user.userId;
            option.textContent = `${user.prefix}${user.name} ${user.surname} (${roleMap[user.role] || user.role})`;
            superviseeSelect.appendChild(option);
        });

        document.getElementById('supervisionDate').valueAsDate = new Date();
    }

    // --- START: ✨ โค้ดที่แก้ไข ---
function showAddTimetableModal() {
    showAddModal('timetableModal', 'timetableModalTitle', 'เพิ่มตารางสอนใหม่', 'saveTimetableBtn', 'บันทึก', 'editTimetableEntryId');

    const { classLevels, subjects, teachers, currentTerm, classRooms } = timetableDropdownData;

    // Populate dropdowns
    const classLevelSelect = document.getElementById('timetableClassLevel');
    classLevelSelect.innerHTML = '<option value="">-- เลือกระดับชั้น --</option>';
    if (classLevels) {
        classLevels.forEach(cl => {
            const option = document.createElement('option');
            option.value = cl.classLevelId;
            option.textContent = cl.className;
            classLevelSelect.appendChild(option);
        });
    }

    const subjectSelect = document.getElementById('timetableSubject');
    subjectSelect.innerHTML = '<option value="">-- เลือกรายวิชา --</option>';
    if (subjects) {
        subjects.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub.subjectId;
            option.textContent = `${sub.subjectCode} - ${sub.subjectName}`;
            // Store subjectType as a data attribute for easy access
            option.dataset.subjectType = sub.subjectType;
            subjectSelect.appendChild(option);
        });
    }

    const teacherSelect = document.getElementById('timetableTeacher');
    teacherSelect.innerHTML = '<option value="">-- เลือกครูผู้สอน --</option>';
    if (teachers) {
        teachers.forEach(teacher => {
            const option = document.createElement('option');
            option.value = teacher.userId;
            option.textContent = `${teacher.prefix}${teacher.name} ${teacher.surname}`;
            teacherSelect.appendChild(option);
        });
    }

    const roomSelect = document.getElementById('timetableRoom');
    roomSelect.innerHTML = '<option value="">-- เลือกห้องเรียน (ถ้ามี) --</option>';
    if (classRooms) {
        classRooms.forEach(room => {
            const option = document.createElement('option');
            option.value = room;
            option.textContent = room;
            roomSelect.appendChild(option);
        });
    }

    // Populate and make academic term fields readonly
    if (currentTerm) {
        document.getElementById('timetableAcademicYear').value = currentTerm.academicYear;
        document.getElementById('timetableSemester').value = currentTerm.semester;
    } else {
        document.getElementById('timetableAcademicYear').value = '';
        document.getElementById('timetableSemester').value = '';
        showErrorAlert('คำเตือน', 'กรุณาตั้งค่าปีการศึกษาปัจจุบันในหน้า "ตั้งค่าระบบ" ก่อน');
    }

    // Add Event Listeners to control UI based on selections
    // Remove existing listeners to prevent duplicates
    subjectSelect.removeEventListener('change', updateTimetableStudentSelectionUI);
    subjectSelect.addEventListener('change', updateTimetableStudentSelectionUI);
    
    classLevelSelect.removeEventListener('change', updateTimetableStudentSelectionUI);
    classLevelSelect.addEventListener('change', updateTimetableStudentSelectionUI);

    // Initial call to set the correct UI state when the modal opens
    updateTimetableStudentSelectionUI();
}

// ฟังก์ชันสำหรับจัดการการบันทึกข้อมูลตารางสอน
async function handleTimetableFormSubmit(e) {
    e.preventDefault();
    const form = e.target;
    if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
    }
    showLoadingAlert('กำลังบันทึกตารางสอน...');

    const entryId = document.getElementById('editTimetableEntryId').value;
    const isEditing = !!entryId;
    
    const subjectId = document.getElementById('timetableSubject').value;
    const subject = timetableDropdownData.subjects.find(s => s.subjectId === subjectId);

    const payload = {
        action: isEditing ? 'update' : 'add',
        timetableData: {
            entryId: entryId,
            academicYear: document.getElementById('timetableAcademicYear').value,
            semester: document.getElementById('timetableSemester').value,
            classLevelId: document.getElementById('timetableClassLevel').value,
            subjectId: subjectId,
            teacherId: document.getElementById('timetableTeacher').value,
            dayOfWeek: document.getElementById('timetableDayOfWeek').value,
            startTime: document.getElementById('timetableStartTime').value,
            endTime: document.getElementById('timetableEndTime').value,
            // ✨ FIX: ส่งข้อมูลนักเรียน/ห้องเรียนตามประเภทวิชา
            room: null,
            studentIds: []
        }
    };

    if (subject && subject.subjectType === 'วิชาเลือกเสรี') {
        const studentSelect = document.getElementById('timetableStudent');
        payload.timetableData.studentIds = Array.from(studentSelect.selectedOptions).map(option => option.value);
    } else {
        payload.timetableData.room = document.getElementById('timetableRoom').value;
    }

    const result = await apiCall('academic/timetable_handler.php', payload);
    if (result.success) {
        bootstrap.Modal.getInstance(document.getElementById('timetableModal')).hide();
        showSuccessAlert('สำเร็จ!', result.message).then(() => loadInitialData());
    } else {
        Swal.close();
        // แสดงข้อความ error ที่ได้จาก backend (รวมถึงข้อความ conflict)
        showErrorAlert('เกิดข้อผิดพลาด', result.error);
    }
}
    
    // --- NEW: Functions to show settings modals ---
    function showAddAcademicTermModal() {
        showAddModal('academicTermModal', 'academicTermModalTitle', 'เพิ่มปีการศึกษา/ภาคเรียน', 'saveAcademicTermBtn', 'บันทึก', 'editTermId');
    }

    function showAddFiscalYearModal() {
        showAddModal('fiscalYearModal', 'fiscalYearModalTitle', 'เพิ่มปีงบประมาณ', 'saveFiscalYearBtn', 'บันทึก', 'editFiscalYearId');
    }

    function showAddHolidayModal() {
        showAddModal('holidayModal', 'holidayModalTitle', 'เพิ่มวันหยุด', 'saveHolidayBtn', 'บันทึก', 'editHolidayId');
        const select = document.getElementById('holidayFiscalYear');
        select.innerHTML = '<option value="">-- เลือกปีงบประมาณ --</option>';
        allSettings.fiscalYears.forEach(fy => {
            select.innerHTML += `<option value="${fy.fiscalYearId}">${fy.year}</option>`;
        });
    }

// --- TABLE ACTIONS (EDIT/DELETE/RESET PASSWORD) ---
async function handleTableActions(e, type) {
    const button = e.target.closest('.action-btn');
    if (!button) return;
    const id = button.closest('tr')?.dataset.id || button.dataset.id;
    const action = button.dataset.action;

    let dataToEdit = null;
    let endpoint = '';
    let modalId = '';
    let titleId = '';
    let saveBtnId = '';

    if (type === 'user') {
        dataToEdit = allUsers.find(i => i.userId === id);
        endpoint = 'admin_handler.php';
        modalId = 'userModal';
        titleId = 'userModalTitle';
        saveBtnId = 'saveUserBtn';
    } else if (type === 'class-level') {
        dataToEdit = allClassLevels.find(i => i.classLevelId === id);
        endpoint = 'class_level_handler.php';
        modalId = 'classLevelModal';
        titleId = 'classLevelModalTitle';
        saveBtnId = 'saveClassLevelBtn';
    } else if (type === 'subject') {
        dataToEdit = allSubjects.find(i => i.subjectId === id);
        endpoint = 'subject_handler.php';
        modalId = 'subjectModal';
        titleId = 'subjectModalTitle';
        saveBtnId = 'saveSubjectBtn';
    } else if (type === 'student') {
        dataToEdit = allStudents.find(i => i.studentId === id);
        endpoint = 'student_handler.php';
        modalId = 'studentModal';
        titleId = 'studentModalTitle';
        saveBtnId = 'saveStudentBtn';
    } else if (type === 'supervision') {
        dataToEdit = allSupervisionRecords.find(i => i.recordId === id);
        endpoint = 'supervision/supervision_handler.php';
        modalId = 'supervisionModal';
        titleId = 'supervisionModalTitle';
        saveBtnId = 'saveSupervisionBtn';
    } else if (type === 'timetable') {
        dataToEdit = allTimetableEntries.find(i => i.entryId === id);
        endpoint = 'academic/timetable_handler.php';
        modalId = 'timetableModal';
        titleId = 'timetableModalTitle';
        saveBtnId = 'saveTimetableBtn';
    }

    if (action === 'edit') {
        if (!dataToEdit) return;

        const modalTitle = `แก้ไขข้อมูล${type === 'student' ? 'นักเรียน' : (type === 'class-level' ? 'ระดับชั้น' : (type === 'subject' ? 'รายวิชา' : (type === 'supervision' ? 'บันทึกการนิเทศ' : (type === 'timetable' ? 'ตารางสอน' : 'ผู้ใช้งาน'))))}`;
        const idField = `edit${type === 'student' ? 'Student' : (type === 'class-level' ? 'ClassLevel' : (type === 'subject' ? 'Subject' : (type === 'supervision' ? 'SupervisionRecord' : (type === 'timetable' ? 'TimetableEntry' : 'User'))))}Id`;
        
        // เปิด Modal และตั้งค่าพื้นฐาน
        const modalEl = document.getElementById(modalId);
        if (!modalEl) return;
        const modal = new bootstrap.Modal(modalEl);
        const form = modalEl.querySelector('form');
        form.reset();
        form.classList.remove('was-validated');
        document.getElementById(titleId).textContent = modalTitle;
        document.getElementById(saveBtnId).innerHTML = `<i class="fas fa-save me-2"></i>อัปเดต`;
        
        // ตั้งค่า ID ในฟอร์มทันที
        document.getElementById(idField).value = id;

        // เติมข้อมูลลงในฟอร์มตามประเภท
        if (type === 'user') {
            document.getElementById('userPrefix').value = dataToEdit.prefix || '';
            document.getElementById('userName').value = dataToEdit.name || '';
            document.getElementById('userSurname').value = dataToEdit.surname || '';
            document.getElementById('userEmployeeId').value = dataToEdit.employeeId || '';
            document.getElementById('userPosition').value = dataToEdit.position || '';
            document.getElementById('userPhone').value = dataToEdit.phone || '';
            document.getElementById('userEmail').value = dataToEdit.email || '';
            document.getElementById('userUsername').value = dataToEdit.username || '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = false;
            document.getElementById('userRole').value = dataToEdit.role || '';
            const userRoleSelect = document.getElementById('userRole');
            const permissionsSection = document.getElementById('teacherPermissionsSection');
            const togglePermissions = () => {
                permissionsSection.style.display = userRoleSelect.value === 'teacher' ? 'block' : 'none';
            };
            document.querySelectorAll('#teacherPermissionsSection .form-check-input').forEach(c => c.checked = false);
            if (dataToEdit.role === 'teacher' && Array.isArray(dataToEdit.permissions)) {
                dataToEdit.permissions.forEach(permissionId => {
                    const checkboxId = `perm-${permissionId.split('-')[0]}`;
                    const checkbox = document.getElementById(checkboxId);
                    if (checkbox) checkbox.checked = true;
                });
            }
            userRoleSelect.removeEventListener('change', togglePermissions);
            userRoleSelect.addEventListener('change', togglePermissions);
            togglePermissions();
        } else if (type === 'class-level') {
            document.getElementById('className').value = dataToEdit.className || '';
            document.getElementById('classDescription').value = dataToEdit.description || '';
        } else if (type === 'subject') {
            document.getElementById('subjectCode').value = dataToEdit.subjectCode || '';
            document.getElementById('subjectName').value = dataToEdit.subjectName || '';
            document.getElementById('subjectCredits').value = dataToEdit.credits || '';
            document.getElementById('subjectType').value = dataToEdit.subjectType || 'วิชาพื้นฐาน';
        } else if (type === 'student') {
            document.getElementById('studentCode').value = dataToEdit.studentCode || '';
            document.getElementById('studentPrefix').value = dataToEdit.prefix || '';
            document.getElementById('studentName').value = dataToEdit.name || '';
            document.getElementById('studentSurname').value = dataToEdit.surname || '';
            document.getElementById('studentDateOfBirth').value = dataToEdit.dateOfBirth || '';
            document.getElementById('studentGender').value = dataToEdit.gender || '';
            const studentGradeSelect = document.getElementById('studentGrade');
            studentGradeSelect.innerHTML = '<option value="">-- เลือกระดับชั้น --</option>';
            allClassLevels.forEach(cl => {
                const option = document.createElement('option');
                option.value = cl.className;
                option.textContent = cl.className;
                studentGradeSelect.appendChild(option);
            });
            studentGradeSelect.value = dataToEdit.grade || '';
            document.getElementById('studentClass').value = dataToEdit.class || '';
            document.getElementById('parentName').value = dataToEdit.parentName || '';
            document.getElementById('parentPhone').value = dataToEdit.parentPhone || '';
        } else if (type === 'supervision') {
            document.getElementById('supervisionDate').value = dataToEdit.supervisionDate || '';
            const supervisorSelect = document.getElementById('supervisorId');
            const superviseeSelect = document.getElementById('superviseeId');
            supervisorSelect.innerHTML = '<option value="">-- เลือกผู้นิเทศ --</option>';
            superviseeSelect.innerHTML = '<option value="">-- เลือกผู้ถูกนิเทศ --</option>';
            const roleMap = { 'teacher': 'ครู/บุคลากร', 'principal': 'ผู้บริหาร', 'admin': 'ผู้ดูแลระบบ' };
            const supervisors = allUsers.filter(u => u.role !== 'admin');
            supervisors.forEach(user => {
                const option1 = document.createElement('option');
                option1.value = user.userId;
                option1.textContent = `${user.prefix}${user.name} ${user.surname} (${roleMap[user.role] || user.role})`;
                supervisorSelect.appendChild(option1);
            });
            const supervisees = allUsers.filter(u => u.role === 'teacher');
            supervisees.forEach(user => {
                const option2 = document.createElement('option');
                option2.value = user.userId;
                option2.textContent = `${user.prefix}${user.name} ${user.surname} (${roleMap[user.role] || user.role})`;
                superviseeSelect.appendChild(option2);
            });
            document.getElementById('supervisorId').value = dataToEdit.supervisorId || '';
            document.getElementById('superviseeId').value = dataToEdit.superviseeId || '';
            document.getElementById('focusArea').value = dataToEdit.focusArea || '';
            document.getElementById('observations').value = dataToEdit.observations || '';
            document.getElementById('feedback').value = dataToEdit.feedback || '';
            document.getElementById('followUp').value = dataToEdit.followUp || '';
            document.getElementById('supervisionStatus').value = dataToEdit.status || 'Completed';
            currentSupervisionResultFile = dataToEdit.resultFiles && dataToEdit.resultFiles.length > 0 ? dataToEdit.resultFiles[0] : null;
            currentSupervisionPhotoFiles = dataToEdit.photos || [];
            renderResultFilePreview();
            renderPhotoFilePreviews();
        } else if (type === 'timetable') {
            // เติมข้อมูลสำหรับ Dropdown ต่างๆ ใน Modal ตารางสอน
            const { classLevels, subjects, teachers, classRooms } = timetableDropdownData;
            const classLevelSelect = document.getElementById('timetableClassLevel');
            classLevelSelect.innerHTML = '<option value="">-- เลือกระดับชั้น --</option>';
            classLevels.forEach(cl => {
                const option = document.createElement('option');
                option.value = cl.classLevelId;
                option.textContent = cl.className;
                classLevelSelect.appendChild(option);
            });

            const subjectSelect = document.getElementById('timetableSubject');
            subjectSelect.innerHTML = '<option value="">-- เลือกรายวิชา --</option>';
            subjects.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.subjectId;
                option.textContent = `${sub.subjectCode} - ${sub.subjectName}`;
                option.dataset.subjectType = sub.subjectType;
                subjectSelect.appendChild(option);
            });

            const teacherSelect = document.getElementById('timetableTeacher');
            teacherSelect.innerHTML = '<option value="">-- เลือกครูผู้สอน --</option>';
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.userId;
                option.textContent = `${teacher.prefix}${teacher.name} ${teacher.surname}`;
                teacherSelect.appendChild(option);
            });

            const roomSelect = document.getElementById('timetableRoom');
            roomSelect.innerHTML = '<option value="">-- เลือกห้องเรียน (ถ้ามี) --</option>';
            classRooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room;
                option.textContent = room;
                roomSelect.appendChild(option);
            });
            
            // เติมข้อมูลเดิมลงในฟอร์ม
            document.getElementById('timetableAcademicYear').value = dataToEdit.academicYear || '';
            document.getElementById('timetableSemester').value = dataToEdit.semester || '';
            document.getElementById('timetableClassLevel').value = dataToEdit.classLevelId || '';
            document.getElementById('timetableSubject').value = dataToEdit.subjectId || '';
            document.getElementById('timetableTeacher').value = dataToEdit.teacherId || '';
            document.getElementById('timetableRoom').value = dataToEdit.room || '';
            document.getElementById('timetableDayOfWeek').value = dataToEdit.dayOfWeek || '';
            document.getElementById('timetableStartTime').value = dataToEdit.startTime || '';
            document.getElementById('timetableEndTime').value = dataToEdit.endTime || '';

            // อัปเดต UI การเลือกนักเรียนให้ถูกต้องตามประเภทวิชา
            updateTimetableStudentSelectionUI();

            // หากเป็นวิชาเลือกเสรี ให้ดึงรายชื่อนักเรียนที่เคยผูกไว้มาแสดง
            if (dataToEdit.subjectType === 'วิชาเลือกเสรี') {
                try {
                    showLoadingAlert('กำลังโหลดรายชื่อนักเรียน...');
                    const linkResponse = await apiCall(endpoint, {
                        action: 'get_students_by_entry',
                        entryId: dataToEdit.entryId
                    });
                    if (linkResponse.success) {
                        const studentSelect = document.getElementById('timetableStudent');
                        Array.from(studentSelect.options).forEach(option => option.selected = false);
                        linkResponse.studentIds.forEach(studentId => {
                            const option = studentSelect.querySelector(`option[value="${studentId}"]`);
                            if (option) {
                                option.selected = true;
                            }
                        });
                    } else {
                        showErrorAlert('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดรายชื่อนักเรียนที่ถูกผูกไว้ได้');
                    }
                } finally {
                    Swal.close();
                }
            }
        }
        
        // แสดง Modal หลังจากเตรียมข้อมูลเสร็จ
        modal.show();
    
    } else if (action === 'delete') {
        if (type === 'user' && id === currentUser.userId) {
            showErrorAlert('ไม่สามารถลบผู้ใช้งานตัวเองได้', 'กรุณาติดต่อผู้ดูแลระบบหากต้องการลบบัญชีนี้');
            return;
        }
        Swal.fire({
            title: 'ยืนยันการลบ?',
            text: "การกระทำนี้ไม่สามารถย้อนกลับได้!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'ใช่, ลบเลย!'
        }).then(async (result) => {
            if (result.isConfirmed) {
                showLoadingAlert('กำลังลบ...');
                const payload = { action: 'delete' };
                if (type === 'user') payload.userId = id;
                else if (type === 'class-level') payload.classLevelId = id;
                else if (type === 'subject') payload.subjectId = id;
                else if (type === 'student') payload.studentId = id;
                else if (type === 'supervision') payload.recordId = id;
                else if (type === 'timetable') payload.entryId = id;
                
                const res = await apiCall(endpoint, payload);
                if (res.success) {
                    showSuccessAlert('สำเร็จ!', res.message).then(() => loadInitialData());
                } else {
                    Swal.close();
                    showErrorAlert('เกิดข้อผิดพลาด', res.error);
                }
            }
        });
    } else if (action === 'reset-password') {
        const {
            value: newPassword
        } = await Swal.fire({
            title: 'รีเซ็ตรหัสผ่าน',
            input: 'password',
            inputPlaceholder: 'กรอกรหัสผ่านใหม่',
            inputValidator: (value) => {
                if (!value) {
                    return 'กรุณากรอกรหัสผ่านใหม่';
                }
            },
            showCancelButton: true
        });
        if (newPassword) {
            showLoadingAlert('กำลังรีเซ็ตรหัสผ่าน...');
            const payload = {
                action: 'reset_password',
                payload: {
                    userId: id,
                    newPassword: newPassword
                }
            };
            const res = await apiCall(endpoint, payload);
            if (res.success) {
                showSuccessAlert('สำเร็จ!', res.message).then(() => loadInitialData());
            } else {
                Swal.close();
                showErrorAlert('เกิดข้อผิดพลาด', res.error);
            }
        }
    }
}

    // --- START: ✨ เพิ่ม Event Listener สำหรับ Pagination Clicks ---
    function handlePaginationClick(e) {
        e.preventDefault();
        const link = e.target.closest('a.page-link');
        if (!link || link.parentElement.classList.contains('disabled')) return;

        const tableKey = link.dataset.key;
        const newPage = parseInt(link.dataset.page, 10);

        if (currentPage[tableKey] !== newPage) {
            currentPage[tableKey] = newPage;
            // เรียกฟังก์ชัน render ที่เกี่ยวข้องตาม tableKey
            switch(tableKey) {
                case 'admin': renderAdminTable(); break;
                case 'classLevel': renderClassLevelTable(); break;
                case 'subject': renderSubjectTable(); break;
                case 'student': renderStudentTable(); break;
                case 'supervision': renderSupervisionTable(); break;
                case 'timetable': renderTimetableTable(); break;
                case 'academicTerms': renderAcademicTermsTable(); break;
                case 'fiscalYears': renderFiscalYearsTable(); break;
                case 'holidays': renderHolidaysTable(); break;
            }
        }
    }
    // --- END: ✨ เพิ่ม Event Listener สำหรับ Pagination Clicks ---

    // --- NEW: Handle actions specifically from settings tables ---
    async function handleSettingsTableActions(e) {
        const button = e.target.closest('.action-btn');
        if (!button) return;
        const id = button.closest('tr')?.dataset.id;
        const action = button.dataset.action;

        let payload = { entity: '', action: '', data: {} };
        let confirmText = '';
        let successMessage = '';

        switch(action) {
            // EDIT
            case 'edit_term':
                const term = allSettings.academicTerms.find(t => t.termId === id);
                if (term) {
                    showAddModal('academicTermModal', 'academicTermModalTitle', 'แก้ไขปีการศึกษา/ภาคเรียน', 'saveAcademicTermBtn', 'อัปเดต', 'editTermId');
                    document.getElementById('editTermId').value = term.termId;
                    document.getElementById('academicYear').value = term.academicYear;
                    document.getElementById('semester').value = term.semester;
                    document.getElementById('termStartDate').value = term.startDate;
                    document.getElementById('termEndDate').value = term.endDate;
                }
                return;
            case 'edit_fy':
                const fy = allSettings.fiscalYears.find(f => f.fiscalYearId === id);
                if (fy) {
                    showAddModal('fiscalYearModal', 'fiscalYearModalTitle', 'แก้ไขปีงบประมาณ', 'saveFiscalYearBtn', 'อัปเดต', 'editFiscalYearId');
                    document.getElementById('editFiscalYearId').value = fy.fiscalYearId;
                    document.getElementById('fiscalYear').value = fy.year;
                    document.getElementById('fiscalStartDate').value = fy.startDate;
                    document.getElementById('fiscalEndDate').value = fy.endDate;
                }
                return;
// ✨ NEW: edit_holiday case in handleSettingsTableActions
case 'edit_holiday':
     const holiday = allSettings.holidays.find(h => h.holidayId === id);
     if (holiday) {
        showAddHolidayModal(); // This also populates the dropdown
        const modalEl = document.getElementById('holidayModal');
        const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
        modal.show();
        
        document.getElementById('holidayModalTitle').textContent = 'แก้ไขวันหยุด';
        document.getElementById('saveHolidayBtn').innerHTML = '<i class="fas fa-sync-alt me-2"></i>อัปเดต';
        document.getElementById('editHolidayId').value = holiday.holidayId;
        document.getElementById('holidayFiscalYear').value = holiday.fiscalYearId;
        document.getElementById('holidayDescription').value = holiday.description;
        document.getElementById('holidayStartDate').value = holiday.startDate;
        document.getElementById('holidayEndDate').value = holiday.endDate;
     }
    return;

            // DELETE
            case 'delete_term':
                payload = { entity: 'academic_term', action: 'delete', data: { termId: id } };
                confirmText = 'ยืนยันการลบปีการศึกษานี้?';
                break;
            case 'delete_fy':
                payload = { entity: 'fiscal_year', action: 'delete', data: { fiscalYearId: id } };
                confirmText = 'ยืนยันการลบปีงบประมาณนี้? (หากมีวันหยุดผูกอยู่ จะไม่สามารถลบได้)';
                break;
            case 'delete_holiday':
                payload = { entity: 'holiday', action: 'delete', data: { holidayId: id } };
                confirmText = 'ยืนยันการลบวันหยุดนี้?';
                break;
            
            // SET CURRENT
            case 'set_current_term':
                payload = { entity: 'academic_term', action: 'set_current', data: { termId: id } };
                successMessage = 'ตั้งเป็นปีการศึกษาปัจจุบันสำเร็จ';
                break;
            case 'set_current_fy':
                payload = { entity: 'fiscal_year', action: 'set_current', data: { fiscalYearId: id } };
                successMessage = 'ตั้งเป็นปีงบประมาณปัจจุบันสำเร็จ';
                break;

            default: return; // No valid action
        }

        if (confirmText) {
             Swal.fire({
                title: confirmText, text: "การกระทำนี้ไม่สามารถย้อนกลับได้!", icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ใช่, ดำเนินการ!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    performApiAction(payload, 'กำลังลบ...');
                }
            });
        } else {
             performApiAction(payload, 'กำลังตั้งค่า...');
        }
    }

    async function performApiAction(payload, loadingText) {
        showLoadingAlert(loadingText);
        const res = await apiCall('settings_handler.php', payload);
        if (res.success) {
            showSuccessAlert('สำเร็จ!', res.message).then(loadInitialData);
        } else {
            Swal.close();
            showErrorAlert('เกิดข้อผิดพลาด', res.error);
        }
    }


    // --- PASSWORD VISIBILITY ---
    function togglePasswordVisibility() {
        const passwordInput = document.getElementById('password');
        const icon = document.querySelector('#toggle-password i');
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            icon.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
            passwordInput.type = 'password';
            icon.classList.replace('fa-eye-slash', 'fa-eye');
        }
    }

    // --- FORGOT PASSWORD ---
    async function handleForgotPassword(e) {
        e.preventDefault();
        const { value: username } = await Swal.fire({
            title: 'ลืมรหัสผ่าน', text: 'กรุณากรอกชื่อผู้ใช้งานของคุณ:', input: 'text',
            inputPlaceholder: 'Username', showCancelButton: true
        });
        if (username) {
            showLoadingAlert('กำลังส่งคำขอ...');
            const result = await apiCall('forgot_password.php', { username });
            if(result.success) { showSuccessAlert('สำเร็จ!', result.message); } else { Swal.close(); showErrorAlert('เกิดข้อผิดพลาด', result.error); }
        }
    }

    // --- FILE HANDLING FOR SCHOOL LOGO ---
    function validateAndDisplayLogoFile(file) {
        if (!file) return;
        const maxSize = 5 * 1024 * 1024; // 5MB
        const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];

        if (file.size > maxSize) {
            showErrorAlert('ไฟล์ใหญ่เกินไป', 'ขนาดไฟล์ต้องไม่เกิน 5MB');
            return;
        }
        if (!allowedTypes.includes(file.type)) {
            showErrorAlert('ประเภทไฟล์ไม่ถูกต้อง', 'รองรับเฉพาะ JPG, PNG, PDF');
            return;
        }

        selectedLogoFile = file;
        document.getElementById('logoFileName').textContent = `ไฟล์: ${file.name}`;
        document.getElementById('removeLogoFileBtn').style.display = 'inline-block';

        // Display image preview if it's an image
        const logoPreview = document.getElementById('logoPreview');
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                logoPreview.src = e.target.result;
                logoPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            logoPreview.style.display = 'none'; // Hide preview for non-images
        }
    }

    function removeLogoFile() {
        selectedLogoFile = null;
        document.getElementById('logoFile').value = '';
        document.getElementById('logoFileName').textContent = '';
        document.getElementById('removeLogoFileBtn').style.display = 'none';
        document.getElementById('logoPreview').style.display = 'none';
        document.getElementById('logoPreview').src = '#'; // Clear preview
        schoolInfo.logoUrl = null; // Clear existing logo URL from state
    }

    // --- FILE HANDLING FOR SUPERVISION FILES ---
    async function uploadFileToServer(file, typeCategory) {
        const formData = new FormData(); 
        formData.append('fileToUpload', file); 
        formData.append('fileTypeCategory', typeCategory); // 'result' or 'photo'

        try {
            const response = await fetch('api/supervision/upload_supervision_file.php', { 
                method: 'POST', 
                body: formData 
            });
            const result = await response.json(); 
            if (!result.success) { 
                throw new Error(result.error); 
            }
            return result; // Returns { success: true, url, fileId, fileName, fileType }
        } catch (error) {
            console.error(`Upload error for ${typeCategory}:`, error);
            return { success: false, error: error.message };
        }
    }

    function validateAndDisplaySupervisionResultFile(file) {
        if (!file) {
            currentSupervisionResultFile = null;
            renderResultFilePreview();
            return;
        }

        const maxSize = 10 * 1024 * 1024; // 10MB
        const allowedMimeTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];

        if (file.size > maxSize) {
            showErrorAlert('ไฟล์ใหญ่เกินไป', 'ขนาดไฟล์ผลการนิเทศต้องไม่เกิน 10MB');
            document.getElementById('supervisionResultFile').value = '';
            currentSupervisionResultFile = null;
            renderResultFilePreview();
            return;
        }
        if (!allowedMimeTypes.includes(file.type)) {
            showErrorAlert('ประเภทไฟล์ไม่ถูกต้อง', 'รองรับเฉพาะ PDF, DOC, DOCX');
            document.getElementById('supervisionResultFile').value = '';
            currentSupervisionResultFile = null;
            renderResultFilePreview();
            return;
        }

        currentSupervisionResultFile = { file: file, fileName: file.name, fileType: file.type };
        renderResultFilePreview();
    }

    function renderResultFilePreview() {
        const fileNameSpan = document.getElementById('resultFileName');
        const removeBtn = document.getElementById('removeResultFileBtn');

        if (currentSupervisionResultFile) {
            fileNameSpan.textContent = `ไฟล์ที่เลือก: ${currentSupervisionResultFile.fileName}`;
            removeBtn.style.display = 'inline-block';
        } else {
            fileNameSpan.textContent = '';
            removeBtn.style.display = 'none';
        }
    }

    function removeSupervisionResultFile() {
        document.getElementById('supervisionResultFile').value = '';
        currentSupervisionResultFile = null;
        renderResultFilePreview();
    }

    function validateAndDisplaySupervisionPhotoFiles(files) {
        if (!files || files.length === 0) {
            currentSupervisionPhotoFiles = [];
            renderPhotoFilePreviews();
            return;
        }

        const maxSize = 5 * 1024 * 1024; // 5MB per photo
        const allowedMimeTypes = ['image/jpeg', 'image/png'];
        const maxPhotos = 5;

        let newPhotos = [];
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            if (file.size > maxSize) {
                showErrorAlert('ไฟล์รูปภาพใหญ่เกินไป', `รูปภาพ "${file.name}" มีขนาดเกิน 5MB จะไม่ถูกเพิ่ม`);
                continue;
            }
            if (!allowedMimeTypes.includes(file.type)) {
                showErrorAlert('ประเภทไฟล์รูปภาพไม่ถูกต้อง', `รูปภาพ "${file.name}" ไม่ใช่ JPG หรือ PNG จะไม่ถูกเพิ่ม`);
                continue;
            }
            newPhotos.push({ file: file, fileName: file.name, fileType: file.type });
        }

        // Combine new photos with existing ones, respecting the maxPhotos limit
        currentSupervisionPhotoFiles = [...currentSupervisionPhotoFiles.filter(p => !p.file), ...newPhotos].slice(0, maxPhotos);
        
        if (currentSupervisionPhotoFiles.length > maxPhotos) {
            showErrorAlert('จำกัดจำนวนรูปภาพ', `สามารถแนบรูปภาพได้สูงสุด ${maxPhotos} รูปเท่านั้น`);
            currentSupervisionPhotoFiles = currentSupervisionPhotoFiles.slice(0, maxPhotos);
        }

        renderPhotoFilePreviews();
    }

    function renderPhotoFilePreviews() {
        const previewContainer = document.getElementById('photoPreviews');
        previewContainer.innerHTML = '';

        currentSupervisionPhotoFiles.forEach((photoObj, index) => {
            const div = document.createElement('div');
            div.className = 'position-relative';
            div.style.width = '100px';
            div.style.height = '100px';
            div.style.overflow = 'hidden';
            div.style.border = '1px solid #ddd';
            div.style.borderRadius = '5px';

            const img = document.createElement('img');
            img.style.width = '100%';
            img.style.height = '100%';
            img.style.objectFit = 'cover';

            if (photoObj.file) { // New file, use FileReader
                const reader = new FileReader();
                reader.onload = (e) => { img.src = e.target.result; };
                reader.readAsDataURL(photoObj.file);
            } else if (photoObj.photoUrl) { // Existing file, use URL
                img.src = photoObj.photoUrl;
            }

            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-danger btn-sm position-absolute top-0 end-0';
            removeBtn.innerHTML = '<i class="fas fa-times-circle"></i>';
            removeBtn.style.zIndex = '10';
            removeBtn.style.padding = '0.1rem 0.3rem';
            removeBtn.onclick = () => removeSupervisionPhoto(index);

            div.appendChild(img);
            div.appendChild(removeBtn);
            previewContainer.appendChild(div);
        });
    }

    function removeSupervisionPhoto(indexToRemove) {
        currentSupervisionPhotoFiles.splice(indexToRemove, 1);
        renderPhotoFilePreviews();
    }

    // ฟังก์ชันสำหรับควบคุม UI การเลือกนักเรียนใน Modal ตารางสอน
function updateTimetableStudentSelectionUI() {
    const subjectSelect = document.getElementById('timetableSubject');
    const selectedSubjectId = subjectSelect.value;
    
    const studentContainer = document.getElementById('timetableStudentContainer');
    const studentSelect = document.getElementById('timetableStudent');
    const roomContainer = document.getElementById('timetableRoom').parentElement; // Get container div

    // หาข้อมูลวิชาที่เลือกจากข้อมูลที่โหลดมา
    const subject = timetableDropdownData.subjects.find(s => s.subjectId === selectedSubjectId);

    if (subject && subject.subjectType === 'วิชาเลือกเสรี') {
        // แสดงช่องเลือกนักเรียน (multiple) และซ่อนช่องเลือกห้อง
        studentContainer.style.display = 'block';
        roomContainer.style.display = 'none';
        document.getElementById('timetableRoom').required = false;
        
        // Populate นักเรียนตามระดับชั้นที่เลือก
        const classLevelId = document.getElementById('timetableClassLevel').value;
        studentSelect.innerHTML = '';
        if (classLevelId && timetableDropdownData.students) {
             const filteredStudents = timetableDropdownData.students.filter(s => {
                const classLevel = timetableDropdownData.classLevels.find(cl => cl.classLevelId === classLevelId);
                return classLevel && s.grade === classLevel.className;
            });
            filteredStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.studentId;
                option.textContent = `${student.grade}/${student.class} - ${student.studentCode} ${student.name}`;
                studentSelect.appendChild(option);
            });
        }

    } else {
        // ซ่อนช่องเลือกนักเรียน และแสดงช่องเลือกห้อง
        studentContainer.style.display = 'none';
        roomContainer.style.display = 'block';
        document.getElementById('timetableRoom').required = true;
    }
}

// --- START: ฟังก์ชันใหม่สำหรับสร้างตารางสอน ---

// ฟังก์ชันสำหรับสร้างสีแบบสุ่มแต่ดูดีสำหรับแต่ละวิชา
const subjectColors = {};
const colorPalette = [
    '#1abc9c', '#2ecc71', '#3498db', '#9b59b6', '#34495e',
    '#f1c40f', '#e67e22', '#e74c3c', '#95a5a6', '#16a085',
    '#27ae60', '#2980b9', '#8e44ad', '#2c3e50', '#f39c12',
    '#d35400', '#c0392b', '#7f8c8d'
];
let colorIndex = 0;

function getSubjectColor(subjectName) {
    if (!subjectColors[subjectName]) {
        subjectColors[subjectName] = colorPalette[colorIndex % colorPalette.length];
        colorIndex++;
    }
    return subjectColors[subjectName];
}

// ฟังก์ชันหลักสำหรับสร้าง HTML ของตารางสอนทั้งหมด
function generateTimetableHTML(entries) {
    if (!entries || entries.length === 0) {
        return '<p class="text-center">ไม่มีข้อมูลตารางสอนสำหรับปีการศึกษาและภาคเรียนที่เลือก</p>';
    }

    // จัดกลุ่มข้อมูลตาม ระดับชั้น -> ห้อง -> วัน -> เวลา
    const groupedByClass = entries.reduce((acc, entry) => {
        const classKey = `${entry.classLevelName || 'N/A'} / ${entry.room || 'N/A'}`;
        if (!acc[classKey]) {
            acc[classKey] = [];
        }
        acc[classKey].push(entry);
        return acc;
    }, {});

    let finalHtml = '';
    const dayMap = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
    const dayThai = ['จันทร์', 'อังคาร', 'พุธ', 'พฤหัสบดี', 'ศุกร์'];

    // วนลูปสร้างตารางสำหรับแต่ละห้องเรียน
    for (const classKey in groupedByClass) {
        const classEntries = groupedByClass[classKey];
        const timeSlots = [...new Set(classEntries.map(e => `${e.startTime} - ${e.endTime}`))].sort();

        finalHtml += `<h4 class="timetable-class-title mt-4">${classKey}</h4>`;
        let tableHtml = '<table class="timetable-view-table"><thead><tr><th class="day-header">คาบ/เวลา</th>';
        
        dayThai.forEach(day => { tableHtml += `<th>${day}</th>`; });
        tableHtml += '</tr></thead><tbody>';

        timeSlots.forEach(slot => {
            tableHtml += `<tr><th>${slot.replace(/:\d{2}\s/g, ' ')}</th>`; // แสดงเวลา
            dayMap.forEach(day => {
                const entry = classEntries.find(e => e.dayOfWeek === day && `${e.startTime} - ${e.endTime}` === slot);
                tableHtml += '<td>';
                if (entry) {
                    const bgColor = getSubjectColor(entry.subjectName);
                    tableHtml += `
                        <div class="timetable-entry" style="background-color: ${bgColor};">
                            <div class="subject">${entry.subjectName}</div>
                            <div class="teacher">${entry.teacherName}</div>
                        </div>
                    `;
                }
                tableHtml += '</td>';
            });
            tableHtml += '</tr>';
        });

        tableHtml += '</tbody></table>';
        finalHtml += tableHtml;
    }
    return finalHtml;
}

// ฟังก์ชันสำหรับเปิด Modal และแสดงตารางสอน
function showTimetableViewModal() {
    const academicYearFilter = document.getElementById('filterAcademicYear').value;
    const semesterFilter = document.getElementById('filterSemester').value;

    // กรองข้อมูลตามที่ผู้ใช้เลือกในหน้าหลัก
    const filteredEntries = allTimetableEntries.filter(entry => {
        const matchesYear = academicYearFilter ? entry.academicYear === academicYearFilter : true;
        const matchesSemester = semesterFilter ? entry.semester === semesterFilter : true;
        return matchesYear && matchesSemester;
    });
    
    // รีเซ็ตสีทุกครั้งที่เปิดใหม่
    colorIndex = 0;
    Object.keys(subjectColors).forEach(key => delete subjectColors[key]);

    const timetableContainer = document.getElementById('timetable-view-body');
    timetableContainer.innerHTML = generateTimetableHTML(filteredEntries);

    const modal = new bootstrap.Modal(document.getElementById('timetable-view-modal'));
    modal.show();
}

// ฟังก์ชันสำหรับสั่งพิมพ์
function printTimetable() {
    window.print();
}

// --- END: ฟังก์ชันใหม่สำหรับสร้างตารางสอน ---


     // --- INITIALIZATION (THIS BLOCK SHOULD BE AT THE END) ---
    document.addEventListener('DOMContentLoaded', () => {

    // --- START: ✨ เพิ่มการตั้งค่า thead ใหม่ ---
    const digitalDocThead = document.querySelector('#digital-document-view thead tr');
    if (digitalDocThead) {
        digitalDocThead.innerHTML = '<th>ลำดับ</th><th>เลขที่เอกสาร</th><th>เรื่อง</th><th>ฝ่ายงาน</th><th>ปี/ภาคเรียน</th><th>ผู้อัปโหลด</th><th>วันที่อัปโหลด</th><th>จัดการ</th>';
    }

        // --- START: ✨ แก้ไขส่วนหัวของตารางทั้งหมดให้มีคอลัมน์ "ลำดับ" ---
        document.querySelector('#admin-view thead tr').innerHTML = '<th>ลำดับ</th><th>ชื่อ-สกุล</th><th>เลขประจำตัว</th><th>ตำแหน่ง</th><th>ชื่อผู้ใช้</th><th>บทบาท</th><th>จัดการ</th>';
        document.querySelector('#class-level-view thead tr').innerHTML = '<th>ลำดับ</th><th>ชื่อระดับชั้น</th><th>คำอธิบาย</th><th>จัดการ</th>';
        document.querySelector('#subject-view thead tr').innerHTML = '<th>ลำดับ</th><th>รหัสวิชา</th><th>ชื่อรายวิชา</th><th>ประเภทวิชา</th><th>หน่วยกิต</th><th>จัดการ</th>';
        document.querySelector('#student-view thead tr').innerHTML = '<th>ลำดับ</th><th>รหัสนักเรียน</th><th>ชื่อ-สกุล</th><th>เพศ</th><th>ระดับชั้น</th><th>ห้อง</th><th>ชื่อผู้ปกครอง</th><th>เบอร์ผู้ปกครอง</th><th>จัดการ</th>';
        document.querySelector('#supervision-view thead tr').innerHTML = '<th>ลำดับ</th><th>วันที่นิเทศ</th><th>ผู้นิเทศ</th><th>ผู้ถูกนิเทศ</th><th>ประเด็นที่นิเทศ</th><th>สถานะ</th><th>จัดการ</th>';
        document.querySelector('#timetable-management-view thead tr').innerHTML = '<th>ลำดับ</th><th>ปี/ภาคเรียน</th><th>ระดับชั้น</th><th>รายวิชา</th><th>ครูผู้สอน</th><th>นักเรียน</th><th>วัน</th><th>เวลา</th><th>ห้อง</th><th>จัดการ</th>';
        document.querySelector('#academic-term-panel thead tr').innerHTML = '<th>ลำดับ</th><th>ปีการศึกษา</th><th>ภาคเรียน</th><th>วันเริ่มต้น</th><th>วันสิ้นสุด</th><th>สถานะปัจจุบัน</th><th>จัดการ</th>';
        document.querySelector('#fiscal-year-panel thead tr').innerHTML = '<th>ลำดับ</th><th>ปีงบประมาณ</th><th>วันเริ่มต้น</th><th>วันสิ้นสุด</th><th>สถานะปัจจุบัน</th><th>จัดการ</th>';
        document.querySelector('#holiday-panel thead tr').innerHTML = '<th>ลำดับ</th><th>คำอธิบาย</th><th>วันเริ่มต้น</th><th>วันสิ้นสุด</th><th>ปีงบประมาณ</th><th>จัดการ</th>';
        // --- END: ✨ แก้ไขส่วนหัวของตาราง ---

        setTimeout(() => { document.getElementById('splash-screen').classList.add('fade-out'); }, 1500);

        document.querySelectorAll('.needs-validation').forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) { 
                    event.preventDefault(); 
                    event.stopPropagation(); 
                }
                form.classList.add('was-validated');
            }, false);
        });

        document.getElementById('viewTimetableBtn')?.addEventListener('click', showTimetableViewModal);
        document.getElementById('printTimetableBtn')?.addEventListener('click', printTimetable);

        // Event Listeners for Login/Logout
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('toggle-password').addEventListener('click', togglePasswordVisibility);
        document.getElementById('forgot-password-link').addEventListener('click', handleForgotPassword);
        
        // Event Listener for Sidebar Toggle
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const sidebarOverlay = document.querySelector('.sidebar-overlay');
        sidebarToggleBtn?.addEventListener('click', () => { sidebar.classList.toggle('active'); sidebarOverlay.classList.toggle('active'); });
        sidebarOverlay?.addEventListener('click', () => { sidebar.classList.remove('active'); sidebarOverlay.classList.remove('active'); });

        // Event Listener for Menu Clicks
        document.getElementById('sidebar').addEventListener('click', handleMenuClick);
        
        // Event Listeners for Forms
        document.getElementById('school-info-form').addEventListener('submit', handleSchoolInfoSubmit);
        document.getElementById('user-form').addEventListener('submit', handleUserFormSubmit);
        document.getElementById('class-level-form').addEventListener('submit', handleClassLevelFormSubmit); 
        document.getElementById('subject-form').addEventListener('submit', handleSubjectFormSubmit); 
        document.getElementById('student-form').addEventListener('submit', handleStudentFormSubmit);
        document.getElementById('supervision-form').addEventListener('submit', handleSupervisionFormSubmit);
        document.getElementById('timetable-form')?.addEventListener('submit', handleTimetableFormSubmit);
        document.getElementById('academic-term-form').addEventListener('submit', handleAcademicTermFormSubmit);
        document.getElementById('fiscal-year-form').addEventListener('submit', handleFiscalYearFormSubmit);
        document.getElementById('holiday-form').addEventListener('submit', handleHolidayFormSubmit);
        document.getElementById('digital-document-form')?.addEventListener('submit', handleDigitalDocumentFormSubmit);
        document.getElementById('digital-document-filter-form')?.addEventListener('submit', filterDigitalDocuments);


        // Event Listeners for "Add New" Buttons
        document.getElementById('addUserBtn')?.addEventListener('click', showAddUserModal);
        document.getElementById('addClassLevelBtn')?.addEventListener('click', showAddClassLevelModal); 
        document.getElementById('addSubjectBtn')?.addEventListener('click', showAddSubjectModal); 
        document.getElementById('addStudentBtn')?.addEventListener('click', showAddStudentModal);
        document.getElementById('addSupervisionBtn')?.addEventListener('click', showAddSupervisionModal);
        document.getElementById('addTimetableBtn')?.addEventListener('click', showAddTimetableModal);
        document.getElementById('addAcademicTermBtn').addEventListener('click', showAddAcademicTermModal);
        document.getElementById('addFiscalYearBtn').addEventListener('click', showAddFiscalYearModal);
        document.getElementById('addHolidayBtn').addEventListener('click', showAddHolidayModal);
        document.getElementById('addDigitalDocumentBtn')?.addEventListener('click', showAddDigitalDocumentModal);

        // --- START: ✨ เพิ่ม Event Listener สำหรับปุ่มใหม่ที่นี่ ---
        document.getElementById('downloadStudentTemplateBtn')?.addEventListener('click', downloadStudentTemplate);
        document.getElementById('importStudentBtn')?.addEventListener('click', () => document.getElementById('studentCsvFile').click());
        document.getElementById('studentCsvFile')?.addEventListener('change', handleStudentImport);
        document.getElementById('searchStudentBtn')?.addEventListener('click', filterAndRenderStudents);
        // --- END: ✨ เพิ่ม Event Listener ---

        // --- START: ✨ แก้ไข Event Listener สำหรับการคลิกทั้งหมด ---
        // เราจะใช้ Event Delegation กับ #main-content ซึ่งเป็น container หลักหลัง login
        const mainContent = document.getElementById('main-content');
        mainContent.addEventListener('click', (e) => {
            const paginationLink = e.target.closest('a.page-link');
            const actionButton = e.target.closest('.action-btn');

            if (paginationLink) {
                handlePaginationClick(e);
            } else if (actionButton) {
                const tableBody = actionButton.closest('tbody');
                if (tableBody) {
                    const tableId = tableBody.id;
                    if (tableId.includes('admin')) handleTableActions(e, 'user');
                    else if (tableId.includes('class-level')) handleTableActions(e, 'class-level');
                    else if (tableId.includes('subject')) handleTableActions(e, 'subject');
                    else if (tableId.includes('student')) handleTableActions(e, 'student');
                    else if (tableId.includes('supervision')) handleTableActions(e, 'supervision');
                    else if (tableId.includes('timetable')) handleTableActions(e, 'timetable');
                    else if (tableId.includes('digital-documents')) handleDigitalDocumentActions(e);                           
                }
            }
        });

        document.getElementById('settings-tab-content').addEventListener('click', handleSettingsTableActions);
        document.getElementById('applyTimetableFilter')?.addEventListener('click', renderTimetableTable);
        
            // --- START: ✨ เพิ่ม event listener สำหรับ file input ของเอกสาร ---
    document.getElementById('docFiles')?.addEventListener('change', (e) => {
        const previewContainer = document.getElementById('doc-file-preview');
        previewContainer.innerHTML = '';
        const files = e.target.files;
        if (files.length > 0) {
            let fileListHtml = '<ul class="list-unstyled mb-0">';
            for (let i = 0; i < files.length; i++) {
                fileListHtml += `<li class="text-muted small"><i class="fas fa-file-alt"></i> ${files[i].name} (${formatBytes(files[i].size)})</li>`;
            }
            fileListHtml += '</ul>';
            if(files.length > 5) {
                 previewContainer.innerHTML = `<p class="text-danger mb-0">คุณเลือก ${files.length} ไฟล์. สามารถอัปโหลดได้สูงสุด 5 ไฟล์เท่านั้น</p>`;
            } else {
                 previewContainer.innerHTML = fileListHtml;
            }
        }
    });
        
        
        // --- END: ✨ แก้ไข Event Listener ---

        // Event Listeners for File Uploads
        const logoDropzone = document.getElementById('logoDropzone');
        logoDropzone?.addEventListener('click', () => document.getElementById('logoFile').click());
        logoDropzone?.addEventListener('dragover', (e) => { e.preventDefault(); e.target.classList.add('dragover'); });
        logoDropzone?.addEventListener('dragleave', (e) => { e.target.classList.remove('dragover'); });
        logoDropzone?.addEventListener('drop', (e) => { e.preventDefault(); e.target.classList.remove('dragover'); validateAndDisplayLogoFile(e.dataTransfer.files[0]); });
        document.getElementById('logoFile')?.addEventListener('change', (e) => validateAndDisplayLogoFile(e.target.files[0]));
        document.getElementById('removeLogoFileBtn')?.addEventListener('click', removeLogoFile);

        const resultFileDropzone = document.getElementById('resultFileDropzone');
        resultFileDropzone?.addEventListener('click', () => document.getElementById('supervisionResultFile').click());
        resultFileDropzone?.addEventListener('dragover', (e) => { e.preventDefault(); e.target.classList.add('dragover'); });
        resultFileDropzone?.addEventListener('dragleave', (e) => { e.target.classList.remove('dragover'); });
        resultFileDropzone?.addEventListener('drop', (e) => { e.preventDefault(); e.target.classList.remove('dragover'); validateAndDisplaySupervisionResultFile(e.dataTransfer.files[0]); });
        document.getElementById('supervisionResultFile')?.addEventListener('change', (e) => validateAndDisplaySupervisionResultFile(e.target.files[0]));
        document.getElementById('removeResultFileBtn')?.addEventListener('click', removeSupervisionResultFile);

        const photoFilesDropzone = document.getElementById('photoFilesDropzone');
        photoFilesDropzone?.addEventListener('click', () => document.getElementById('supervisionPhotoFiles').click());
        photoFilesDropzone?.addEventListener('dragover', (e) => { e.preventDefault(); e.target.classList.add('dragover'); });
        photoFilesDropzone?.addEventListener('dragleave', (e) => { e.target.classList.remove('dragover'); });
        photoFilesDropzone?.addEventListener('drop', (e) => { e.preventDefault(); e.target.classList.remove('dragover'); validateAndDisplaySupervisionPhotoFiles(e.dataTransfer.files); });
        document.getElementById('supervisionPhotoFiles')?.addEventListener('change', (e) => validateAndDisplaySupervisionPhotoFiles(e.target.files));
    });

</script>
</body>
</html>